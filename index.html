<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–®–ø–∏–æ–Ω Online üïµÔ∏è‚Äç‚ôÇÔ∏è</title>
    <!-- –®—Ä–∏—Ñ—Ç -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&display=swap" rel="stylesheet">
    <!-- –ú–∞–≥–∏—è –¥–ª—è –æ–Ω–ª–∞–π–Ω–∞ -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --primary: #ff4757;
            --secondary: #2ed573;
            --dark: #2f3542;
            --bg: #1e272e;
        }

        body {
            margin: 0;
            font-family: 'Nunito', sans-serif;
            background: var(--bg);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .container {
            width: 90%;
            max-width: 500px;
            padding: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px 20px;
            border: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        h1 { margin: 0 0 20px 0; font-size: 2rem; }
        p { color: #ccc; }

        input {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            margin-bottom: 15px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            box-sizing: border-box;
            text-transform: uppercase;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border-radius: 12px;
            border: none;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-create { background: var(--primary); color: white; }
        .btn-join { background: var(--secondary); color: white; }
        .btn-role { background: #3742fa; color: white; margin-top: 20px;}

        .screen { display: none; }
        .active { display: block; }

        /* –õ–æ–±–±–∏ */
        .room-code {
            font-size: 3rem;
            letter-spacing: 5px;
            color: var(--secondary);
            font-weight: 800;
            margin: 20px 0;
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 10px;
        }

        .player-list {
            text-align: left;
            margin: 20px 0;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
            min-height: 100px;
        }
        .player-item { padding: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* –ò–≥—Ä–∞ */
        .role-hidden {
            width: 150px; height: 150px;
            background: #ccc;
            border-radius: 50%;
            margin: 0 auto;
            display: flex; align-items: center; justify-content: center;
            font-size: 3rem; color: #333; cursor: pointer;
        }
        .role-img {
            width: 100%; height: 100%;
            object-fit: cover;
            border-radius: 20px;
            border: 4px solid white;
        }
        
        .blur-content { filter: blur(15px); transition: 0.3s; }
        .role-revealed .blur-content { filter: blur(0); }

        .spy-alert {
            color: var(--primary);
            font-size: 2.5rem;
            font-weight: 800;
            border: 5px solid var(--primary);
            padding: 20px;
            border-radius: 20px;
        }
    </style>
</head>
<body>

    <div class="container">

        <!-- –ì–õ–ê–í–ù–û–ï –ú–ï–ù–Æ -->
        <div id="screen-menu" class="screen active">
            <div class="card">
                <h1>üïµÔ∏è‚Äç‚ôÇÔ∏è SPY ONLINE</h1>
                <input type="text" id="my-name" placeholder="–¢–í–û–ï –ò–ú–Ø">
                <button class="btn btn-create" onclick="createGame()">–°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
                <div style="margin: 10px 0; font-size: 0.8rem; opacity: 0.5;">‚Äî –ò–õ–ò ‚Äî</div>
                <input type="text" id="join-code" placeholder="–ö–û–î –ö–û–ú–ù–ê–¢–´">
                <button class="btn btn-join" onclick="joinGame()">–í–û–ô–¢–ò</button>
            </div>
        </div>

        <!-- –õ–û–ë–ë–ò (–î–õ–Ø –•–û–°–¢–ê) -->
        <div id="screen-host" class="screen">
            <div class="card">
                <p>–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã:</p>
                <div class="room-code" id="display-code">...</div>
                <p>–ò–≥—Ä–æ–∫–∏:</p>
                <div class="player-list" id="host-player-list"></div>
                
                <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏:</p>
                <select id="pack-select" style="width:100%; padding:10px; border-radius:10px; margin-bottom:10px;">
                    <option value="dota">Dota 2</option>
                    <option value="clash">Clash Royale</option>
                    <option value="mix">–ú–∏–∫—Å (–í—Å—ë –≤–º–µ—Å—Ç–µ)</option>
                </select>

                <button class="btn btn-create" onclick="hostStartGame()">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
            </div>
        </div>

        <!-- –õ–û–ë–ë–ò (–î–õ–Ø –ò–ì–†–û–ö–ê) -->
        <div id="screen-wait" class="screen">
            <div class="card">
                <h1>–ñ–¥–µ–º —Ö–æ—Å—Ç–∞...</h1>
                <p>–¢—ã –≤ –ª–æ–±–±–∏.</p>
                <p>–ù–µ –∑–∞–∫—Ä—ã–≤–∞–π —Å—Ç—Ä–∞–Ω–∏—Ü—É.</p>
                <div style="font-size: 3rem; margin-top:20px;">‚òï</div>
            </div>
        </div>

        <!-- –≠–ö–†–ê–ù –ò–ì–†–´ (–†–û–õ–¨) -->
        <div id="screen-game" class="screen">
            <div class="card">
                <h2>–¢–≤–æ—è —Ä–æ–ª—å:</h2>
                <p style="font-size: 0.8rem;">–ù–∞–∂–º–∏ –∏ —É–¥–µ—Ä–∂–∏–≤–∞–π –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å</p>
                
                <div id="role-area" style="margin: 20px 0; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                    <!-- –°—é–¥–∞ –ø—Ä–∏–ª–µ—Ç–∏—Ç —Ä–æ–ª—å -->
                    <div style="font-size: 5rem;">‚ùì</div>
                </div>

                <button class="btn btn-role" 
                    onmousedown="reveal(true)" 
                    onmouseup="reveal(false)" 
                    ontouchstart="reveal(true)" 
                    ontouchend="reveal(false)">
                    –ü–û–ö–ê–ó–ê–¢–¨
                </button>
            </div>
            <div class="card" style="margin-top: 20px; background: rgba(0,0,0,0.5);">
                <p>–¢–∞–π–º–µ—Ä –∑–∞–ø—É—Å—Ç–∏—Ç —Ö–æ—Å—Ç</p>
            </div>
        </div>

    </div>

    <script>
        // === –î–ê–ù–ù–´–ï ===
        const PACKS = {
            dota: [
                { name: "Pudge", img: "pudge.jpg" },
                { name: "Invoker", img: "invoker.jpg" },
                { name: "Crystal Maiden", img: "cm.jpg" },
                { name: "Techies", img: "techies.jpg" },
                { name: "Roshan", img: "roshan.jpg" },
                { name: "Sniper", img: "sniper.jpg" },
                { name: "Axe", img: "axe.jpg" }
            ],
            clash: [
                { name: "Hog Rider", img: "hog.jpg" },
                { name: "P.E.K.K.A", img: "pekka.jpg" },
                { name: "Goblin Barrel", img: "goblin.jpg" },
                { name: "Mega Knight", img: "mk.jpg" },
                { name: "Princess", img: "princess.jpg" },
                { name: "Giant", img: "giant.jpg" },
                { name: "Skeleton", img: "larry.jpg" }
            ]
        };

        // === –ü–ï–†–ï–ú–ï–ù–ù–´–ï ===
        let myPeer = null;
        let myConn = null; // –î–ª—è –∏–≥—Ä–æ–∫–∞: —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º
        let connections = []; // –î–ª—è —Ö–æ—Å—Ç–∞: —Å–ø–∏—Å–æ–∫ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π —Å –∏–≥—Ä–æ–∫–∞–º–∏
        let myName = "";
        let isHost = false;
        
        // –ü—Ä–µ—Ñ–∏–∫—Å –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ ID –≤ PeerJS
        const APP_PREFIX = "spy-game-v1-"; 

        // === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
        function createGame() {
            myName = document.getElementById('my-name').value || "–•–æ—Å—Ç";
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –∫–æ–¥ –∏–∑ 4 —Å–∏–º–≤–æ–ª–æ–≤
            const code = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            initPeer(code, true);
        }

        function joinGame() {
            myName = document.getElementById('my-name').value || "–ò–≥—Ä–æ–∫";
            const code = document.getElementById('join-code').value.toUpperCase();
            
            if (code.length < 3) { alert("–í–≤–µ–¥–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π –∫–æ–¥!"); return; }
            
            initPeer(null, false, code);
        }

        function initPeer(code, hostMode, targetCode = null) {
            // –°–æ–∑–¥–∞–µ–º —Å–≤–æ–π ID. –ï—Å–ª–∏ —Ö–æ—Å—Ç - —Ç–æ ID —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ –∫–æ–¥—É. –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ - —Å–ª—É—á–∞–π–Ω—ã–π.
            const peerId = hostMode ? (APP_PREFIX + code) : undefined;

            myPeer = new Peer(peerId);

            myPeer.on('open', (id) => {
                if (hostMode) {
                    isHost = true;
                    showScreen('screen-host');
                    document.getElementById('display-code').innerText = code;
                    updateHostList();
                } else {
                    connectToHost(targetCode);
                }
            });

            myPeer.on('connection', (conn) => {
                if (isHost) {
                    handleIncomingConnection(conn);
                }
            });
            
            myPeer.on('error', (err) => {
                console.error(err);
                if(err.type === 'unavailable-id') {
                    alert("–≠—Ç–æ—Ç –∫–æ–¥ —É–∂–µ –∑–∞–Ω—è—Ç! –ü–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.");
                    location.reload();
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑.");
                }
            });
        }

        // === –õ–û–ì–ò–ö–ê –•–û–°–¢–ê ===
        function handleIncomingConnection(conn) {
            connections.push(conn);
            
            conn.on('open', () => {
                // –ñ–¥–µ–º, –ø–æ–∫–∞ –∏–≥—Ä–æ–∫ –ø—Ä–∏—à–ª–µ—Ç —Å–≤–æ–µ –∏–º—è
                conn.on('data', (data) => {
                    if (data.type === 'join') {
                        conn.playerName = data.name;
                        updateHostList();
                    }
                });
            });

            conn.on('close', () => {
                connections = connections.filter(c => c !== conn);
                updateHostList();
            });
        }

        function updateHostList() {
            const list = document.getElementById('host-player-list');
            list.innerHTML = `<div class="player-item">üëë ${myName} (–¢—ã)</div>`;
            connections.forEach(conn => {
                const name = conn.playerName || "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...";
                list.innerHTML += `<div class="player-item">üë§ ${name}</div>`;
            });
        }

        function hostStartGame() {
            const totalPlayers = connections.length + 1; // –•–æ—Å—Ç + –æ—Å—Ç–∞–ª—å–Ω—ã–µ
            if (totalPlayers < 3) {
                alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 —á–µ–ª–æ–≤–µ–∫–∞!");
                return;
            }

            // –í—ã–±–∏—Ä–∞–µ–º —à–ø–∏–æ–Ω–∞ (0 - —Ö–æ—Å—Ç, 1..N - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è)
            const spyIndex = Math.floor(Math.random() * totalPlayers);
            
            // –í—ã–±–∏—Ä–∞–µ–º –ª–æ–∫–∞—Ü–∏—é
            const packName = document.getElementById('pack-select').value;
            let pool = [];
            if (packName === 'mix') pool = [...PACKS.dota, ...PACKS.clash];
            else pool = PACKS[packName];
            
            const location = pool[Math.floor(Math.random() * pool.length)];

            // –†–∞—Å—Å—ã–ª–∞–µ–º —Ä–æ–ª–∏
            // 1. –°–Ω–∞—á–∞–ª–∞ —Å–µ–±–µ (–•–æ—Å—Ç—É)
            if (spyIndex === 0) {
                setMyRole('SPY', null);
            } else {
                setMyRole('CITIZEN', location);
            }

            // 2. –í—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º
            connections.forEach((conn, index) => {
                // index + 1, —Ç.–∫. 0 —ç—Ç–æ —Ö–æ—Å—Ç
                const isSpy = (index + 1) === spyIndex;
                conn.send({
                    type: 'start',
                    role: isSpy ? 'SPY' : 'CITIZEN',
                    location: location
                });
            });
        }

        // === –õ–û–ì–ò–ö–ê –ò–ì–†–û–ö–ê ===
        function connectToHost(code) {
            const hostId = APP_PREFIX + code;
            myConn = myPeer.connect(hostId);

            myConn.on('open', () => {
                showScreen('screen-wait');
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–µ –∏–º—è
                myConn.send({ type: 'join', name: myName });
            });

            myConn.on('data', (data) => {
                if (data.type === 'start') {
                    setMyRole(data.role, data.location);
                }
            });

            myConn.on('close', () => {
                alert("–•–æ—Å—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è!");
                location.reload();
            });
            
            // –¢–∞–π–º–µ—Ä –æ–∂–∏–¥–∞–Ω–∏—è (–µ—Å–ª–∏ –∫–æ–¥ –Ω–µ–≤–µ—Ä–Ω—ã–π, PeerJS –∏–Ω–æ–≥–¥–∞ —Ç—É–ø–∏—Ç)
            setTimeout(() => {
                if(!myConn.open) {
                    alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥!");
                    location.reload();
                }
            }, 5000);
        }

        // === –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê –ò–ì–†–´ ===
        function setMyRole(role, locationData) {
            showScreen('screen-game');
            const area = document.getElementById('role-area');
            
            if (role === 'SPY') {
                area.innerHTML = `
                    <div id="secret-content" style="display:none;">
                        <div class="spy-alert">–¢–´ –®–ü–ò–û–ù! ü§´</div>
                        <p>–ù–µ —Å–ø–∞–ª–∏—Å—å!</p>
                    </div>
                `;
            } else {
                area.innerHTML = `
                    <div id="secret-content" style="display:none; text-align:center;">
                        <img src="${locationData.img}" class="role-img" onerror="this.src='https://via.placeholder.com/200?text=Error'">
                        <h2>${locationData.name}</h2>
                    </div>
                `;
            }
        }

        function reveal(shouldShow) {
            const content = document.getElementById('secret-content');
            if(content) {
                content.style.display = shouldShow ? 'block' : 'none';
            }
        }

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    </script>
</body>
</html>
