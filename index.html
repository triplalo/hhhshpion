<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>DOTA SPY GAME (Improved)</title>
  <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —à—Ä–∏—Ñ—Ç–∞ –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫ PeerJS –∏ confetti -->
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* ... —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏ ... */
    /* (–û–ø—É—â–µ–Ω–æ –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏, —Å—Ç–∏–ª–∏ –Ω–µ –∏–∑–º–µ–Ω—è–ª–∏—Å—å) */
  </style>
</head>
<body>
  <!-- HTML —Ä–∞–∑–º–µ—Ç–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (–º–µ–Ω—é, –ª–æ–±–±–∏, –∏–≥—Ä–∞) -->
  <div id="secret-modal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); color:#ec4899; font-size:1.5rem; font-weight:bold; opacity:0; pointer-events:none; transition:0.5s;">–Ø –ª—é–±–ª—é –°–æ–Ω—é ‚ù§Ô∏è</div>
  <div class="easter-egg-zone" onclick="triggerEasterEgg()"></div>

  <!-- 1. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é -->
  <div id="screen-menu" class="screen active">
    <h1>Spy Game</h1>
    <div class="card">
      <div class="input-group">
        <label>–ù–ò–ö–ù–ï–ô–ú</label>
        <input type="text" id="nick-inp" placeholder="–¢–≤–æ–µ –∏–º—è">
      </div>
      <button class="btn btn-primary" onclick="Net.host()">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
      <div style="height: 1px; background: var(--border); margin: 20px 0;"></div>
      <div class="input-group">
        <label>–ö–û–î –ö–û–ú–ù–ê–¢–´ (4 –ë–£–ö–í–´)</label>
        <input type="text" id="code-inp" placeholder="XXXX" style="letter-spacing: 5px; text-transform: uppercase;">
      </div>
      <button class="btn btn-outline" onclick="Net.join()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </div>
    <p style="text-align:center; color:#333; font-size:0.8rem; margin-top:auto;">v9.0 | No more limits</p>
  </div>

  <!-- 2. –õ–æ–±–±–∏ -->
  <div id="screen-lobby" class="screen">
    <div class="card" style="text-align:center;">
      <label>–ö–û–î –î–õ–Ø –í–•–û–î–ê</label>
      <div class="room-code-display" id="lobby-code-display">....</div>
      <button class="btn btn-link" onclick="Game.copyInvite()">üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
      <div id="host-settings-panel" style="margin-top:15px; display:none;">
        <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à–ø–∏–æ–Ω–æ–≤</label>
        <select id="spy-count" onchange="Game.sendSettings()">
          <option value="1">1 –®–ø–∏–æ–Ω</option>
          <option value="2">2 –®–ø–∏–æ–Ω–∞</option>
          <option value="3">3 –®–ø–∏–æ–Ω–∞ (–•–∞–æ—Å)</option>
        </select>
      </div>
    </div>
    <label style="padding: 0 4px;">–ò–ì–†–û–ö–ò –û–ù–õ–ê–ô–ù</label>
    <div class="player-list" id="player-list-container"></div>
    <div style="margin-top: 15px;">
      <button id="btn-ready" class="btn btn-outline" onclick="Game.toggleReady()">–ì–û–¢–û–í</button>
      <button id="btn-start" class="btn btn-primary" onclick="Game.startGame()" style="display:none;">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
    </div>
    <!-- –ß–∞—Ç –ª–æ–±–±–∏ -->
    <div class="chat-section">
      <div class="chat-history" id="chat-lobby"></div>
      <div class="chat-form">
        <input type="text" class="chat-inp" id="chat-inp-lobby" placeholder="–ß–∞—Ç...">
        <button class="chat-btn" onclick="Game.sendChat('lobby')">‚û§</button>
      </div>
    </div>
  </div>

  <!-- 3. –≠–∫—Ä–∞–Ω –∏–≥—Ä—ã -->
  <div id="screen-game" class="screen">
    <div class="role-wrapper">
      <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–∫–∞–∑–∞ —Ä–æ–ª–∏ (—É–¥–µ—Ä–∂–∏–≤–∞—Ç—å) -->
      <div class="role-reveal-btn" id="reveal-btn"
           onmousedown="Game.reveal(true)" onmouseup="Game.reveal(false)"
           onmouseleave="Game.reveal(false)"
           ontouchstart="Game.reveal(true)" ontouchend="Game.reveal(false)"
           ontouchcancel="Game.reveal(false)">
        <span style="pointer-events: none;">–£–î–ï–†–ñ–ò–í–ê–ô<br>–ß–¢–û–ë–´<br>–£–ó–ù–ê–¢–¨ –†–û–õ–¨</span>
      </div>
      <!-- –û–≤–µ—Ä–ª–µ–π —Ä–æ–ª–∏ -->
      <div id="role-overlay" class="role-content">
        <div id="role-icon" class="role-icon"></div>
        <div id="role-text" class="role-hero"></div>
        <div id="role-sub" class="role-sub"></div>
      </div>
    </div>
    <div class="card">
      <button class="btn btn-danger" onclick="alert('–û–±—Å—É–¥–∏—Ç–µ –≥–æ–ª–æ—Å–æ–º –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —à–ø–∏–æ–Ω–∞!')">üö® –í–´–ó–í–ê–¢–¨ –ì–û–õ–û–°–û–í–ê–ù–ò–ï</button>
      <button id="host-end-btn" class="btn btn-ghost" onclick="Game.endRound()" style="display:none; margin-bottom:0;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É (–•–æ—Å—Ç)</button>
    </div>
    <!-- –ß–∞—Ç —Ä–∞—É–Ω–¥–∞ -->
    <div class="chat-section" style="height: 120px;">
      <div class="chat-history" id="chat-game"></div>
      <div class="chat-form">
        <input type="text" class="chat-inp" id="chat-inp-game" placeholder="–û–±—Å—É–∂–¥–µ–Ω–∏–µ...">
        <button class="chat-btn" onclick="Game.sendChat('game')">‚û§</button>
      </div>
    </div>
  </div>

  <div id="conn-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>

  <script>
    // --- –î–ê–ù–ù–´–ï ---
    const DOTA_HEROES = [ /* ... –º–∞—Å—Å–∏–≤ –∏–º–µ–Ω –≥–µ—Ä–æ–µ–≤, –æ–ø—É—â–µ–Ω –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏ ... */ ];

    // --- –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    const App = {
      state: {
        phase: 'menu',        // —Ç–µ–∫—É—â–∞—è —Ñ–∞–∑–∞: menu, lobby, game
        roomCode: '',
        players: [],          // —Å–ø–∏—Å–æ–∫ –∏–≥—Ä–æ–∫–æ–≤ {id, name, ready, isSpy, hero, spyStreak}
        chat: [],             // —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞ {name, text}
        config: { spies: 1 }  // –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–ø–∏–æ–Ω–æ–≤
      },
      me: { id: null, name: '', isHost: false },
      hostData: { 
        conns: [],   // –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (–¥–ª—è —Ö–æ—Å—Ç–∞)
        hero: ''     // –∑–∞–≥–∞–¥–∞–Ω—ã–π –≥–µ—Ä–æ–π (–¥–ª—è —Ö–æ—Å—Ç–∞, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ)
      }
    };

    // --- –°–ï–¢–ï–í–û–ô –ú–û–î–£–õ–¨ (PeerJS) ---
    const Net = {
      peer: null,
      conn: null,
      log: (txt) => {
        document.getElementById('conn-status').innerText = txt;
        console.log("[Net]", txt);
      },
      // –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–±–±–∏ (—Ö–æ—Å—Ç)
      host: function() {
        App.me.name = document.getElementById('nick-inp').value.trim() || "Host";
        App.me.isHost = true;
        const code = this.generateCode();
        App.state.roomCode = code;
        const peerId = `spy-game-v9-${code}`;
        this.log("–°–æ–∑–¥–∞—é —Å–µ—Ä–≤–µ—Ä: " + code);
        this.initPeer(peerId);
      },
      // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ª–æ–±–±–∏ (–∫ —Ö–æ—Å—Ç—É)
      join: function() {
        App.me.name = document.getElementById('nick-inp').value.trim() || "Player";
        App.me.isHost = false;
        const code = document.getElementById('code-inp').value.trim().toUpperCase();
        if(code.length !== 4) return alert("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ 4 –±—É–∫–≤");
        const peerId = `spy-client-${Math.random().toString(36).substr(2, 9)}`;
        this.initPeer(peerId, code);
      },
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è PeerJS
      initPeer: function(id, targetCode = null) {
        if(this.peer) this.peer.destroy();
        this.peer = new Peer(id);
        this.peer.on('open', (myId) => {
          App.me.id = myId;
          this.log("–û–Ω–ª–∞–π–Ω. ID: " + myId);
          if(App.me.isHost) {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ö–æ—Å—Ç–∞
            App.state.players = [{ 
              id: myId, name: App.me.name, ready: true, 
              isSpy: false, spyStreak: 0 
            }];
            Game.enterLobby();
          } else {
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Ö–æ—Å—Ç—É
            const hostId = `spy-game-v9-${targetCode}`;
            this.connectToHost(hostId);
          }
        });
        this.peer.on('error', (err) => {
          console.error(err);
          if(err.type === 'unavailable-id') {
            if(App.me.isHost) {
              alert("–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã —É–∂–µ –∑–∞–Ω—è—Ç, –ø—Ä–æ–±—É—é –¥—Ä—É–≥–æ–π...");
              // –ü—Ä–∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–µ –∫–æ–¥–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å
              const newCode = this.generateCode();
              App.state.roomCode = newCode;
              const newPeerId = `spy-game-v9-${newCode}`;
              if(this.peer) this.peer.destroy();
              this.initPeer(newPeerId);
            }
          } else if (err.type === 'peer-unavailable') {
            alert("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥.");
            this.log("–•–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
          } else {
            alert("Network Error: " + err.type);
          }
        });
        // –•–æ—Å—Ç: –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
        if(App.me.isHost) {
          this.peer.on('connection', (c) => {
            App.hostData.conns.push(c);
            c.on('data', (data) => this.handleDataAsHost(data, c.peer));
            c.on('close', () => {
              // –ò–≥—Ä–æ–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è
              const pl = App.state.players.find(p => p.id === c.peer);
              if(pl) {
                Net.pushChat({ name: '–°–∏—Å—Ç–µ–º–∞', text: `${pl.name} –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É.` });
              }
              App.hostData.conns = App.hostData.conns.filter(x => x !== c);
              App.state.players = App.state.players.filter(p => p.id !== c.peer);
              this.broadcast();
            });
            // **–ù–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–æ–ª—å—à–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.**
            // –ù–æ–≤–æ–º—É –∏–≥—Ä–æ–∫—É —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏—à–ª—ë–º –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –µ–≥–æ JOIN.
          });
        }
      },
      connectToHost: function(hostId) {
        this.log("–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ " + hostId);
        this.conn = this.peer.connect(hostId);
        this.conn.on('open', () => {
          this.log("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ");
          this.conn.send({ type: 'JOIN', name: App.me.name });
        });
        this.conn.on('data', (data) => {
          if(data.type === 'SYNC') {
            App.state = data.state;
            Game.render();
          }
        });
        this.conn.on('close', () => {
          alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ.");
          location.reload();
        });
      },
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–∞–Ω–Ω—ã—Ö (—Ç–æ–ª—å–∫–æ –Ω–∞ —Ö–æ—Å—Ç–µ)
      handleDataAsHost: function(data, peerId) {
        let changed = false;
        if(data.type === 'JOIN') {
          // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ —Ö–æ—á–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
          if(!App.state.players.find(p => p.id === peerId)) {
            App.state.players.push({
              id: peerId, name: data.name, 
              ready: false, isSpy: false, spyStreak: 0
            });
            // –°–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            this.pushChat({ name: '–°–∏—Å—Ç–µ–º–∞', text: `${data.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ.` });
            changed = true;
          }
        }
        if(data.type === 'READY') {
          const p = App.state.players.find(x => x.id === peerId);
          if(p) { p.ready = !p.ready; changed = true; }
        }
        if(data.type === 'CHAT') {
          this.pushChat(data.msg);
          changed = true;
        }
        if(changed) this.broadcast();
      },
      pushChat: function(msg) {
        App.state.chat.push(msg);
        if(App.state.chat.length > 50) App.state.chat.shift();
      },
      // –†–∞—Å—Å—ã–ª–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –≤—Å–µ–º (—Ç–æ–ª—å–∫–æ —Ö–æ—Å—Ç)
      broadcast: function() {
        Game.render();  // –æ–±–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ö–æ—Å—Ç–∞
        App.hostData.conns.forEach(c => {
          if(c.open) {
            // –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            const stateCopy = JSON.parse(JSON.stringify(App.state));
            const selfPlayer = stateCopy.players.find(p => p.id === c.peer);
            if(selfPlayer) {
              if(selfPlayer.isSpy) {
                // –®–ø–∏–æ–Ω: —É–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥–µ—Ä–æ–µ —É –≤—Å–µ—Ö
                stateCopy.players.forEach(pl => {
                  pl.hero = "";  // –≥–µ—Ä–æ–π –Ω–µ –∏–∑–≤–µ—Å—Ç–µ–Ω
                  if(pl.id !== selfPlayer.id) {
                    pl.isSpy = false; // –¥—Ä—É–≥–∏–µ —à–ø–∏–æ–Ω—ã –Ω–µ —Ä–∞—Å–∫—Ä—ã—Ç—ã
                  }
                });
                // (selfPlayer.isSpy –æ—Å—Ç–∞—ë—Ç—Å—è true, —à–ø–∏–æ–Ω –∑–Ω–∞–µ—Ç —á—Ç–æ –æ–Ω —à–ø–∏–æ–Ω)
              } else {
                // –ú–∏—Ä–Ω—ã–π: —Å–∫—Ä—ã—Ç—å —Ä–æ–ª–∏ —à–ø–∏–æ–Ω–æ–≤ (–Ω–∏–∫—Ç–æ –Ω–µ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ —à–ø–∏–æ–Ω)
                stateCopy.players.forEach(pl => {
                  pl.isSpy = false;
                });
                // (–Ω–∞–∑–≤–∞–Ω–∏–µ –≥–µ—Ä–æ—è –æ—Å—Ç–∞—ë—Ç—Å—è, —Ç.–∫. –º–∏—Ä–Ω—ã–µ –µ–≥–æ –∑–Ω–∞—é—Ç)
              }
            }
            c.send({ type: 'SYNC', state: stateCopy });
          }
        });
      },
      generateCode: function() {
        const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
        let res = "";
        for(let i=0; i<4; i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
        return res;
      }
    };

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–´ ---
    const Game = {
      enterLobby: function() {
        App.state.phase = 'lobby';
        Net.broadcast();
      },
      toggleReady: function() {
        if(App.me.isHost) return;
        Net.conn.send({ type: 'READY' });
      },
      sendChat: function(ctx) {
        const el = document.getElementById(`chat-inp-${ctx}`);
        const text = el.value.trim();
        if(!text) return;
        const msg = { name: App.me.name, text: text };
        if(App.me.isHost) {
          Net.pushChat(msg);
          Net.broadcast();
        } else {
          Net.conn.send({ type: 'CHAT', msg: msg });
        }
        el.value = '';
      },
      sendSettings: function() {
        if(!App.me.isHost) return;
        App.state.config.spies = parseInt(document.getElementById('spy-count').value);
        Net.broadcast();
      },
      // --- –ó–∞–ø—É—Å–∫ —Ä–∞—É–Ω–¥–∞ (–≤—ã–±–æ—Ä —à–ø–∏–æ–Ω–∞ –∏ —Ä–∞–∑–¥–∞—á–∞ —Ä–æ–ª–µ–π) ---
      startGame: function() {
        const count = App.state.players.length;
        if(count < 3) return alert("–ú–∏–Ω–∏–º—É–º 3 –∏–≥—Ä–æ–∫–∞!");
        // –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ –ª–∏ –Ω–∞–∂–∞–ª–∏ "–ì–æ—Ç–æ–≤"
        const allReady = App.state.players.every(p => p.ready);
        if(!allReady) {
          return alert("–ù–µ –≤—Å–µ –∏–≥—Ä–æ–∫–∏ –≥–æ—Ç–æ–≤—ã!");
        }
        // 1. –í—ã–±–æ—Ä –≥–µ—Ä–æ—è —Å–ª—É—á–∞–π–Ω–æ
        const hero = DOTA_HEROES[Math.floor(Math.random() * DOTA_HEROES.length)];
        // 2. –°–æ—Å—Ç–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –≤ —à–ø–∏–æ–Ω—ã (—É—á—ë—Ç —Å–µ—Ä–∏–π)
        let candidates = App.state.players.filter(p => p.spyStreak < 3);
        if(candidates.length < App.state.config.spies) {
          candidates = [...App.state.players];
        }
        // 3. –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
        for (let i = candidates.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
        }
        // 4. –í—ã–±–∏—Ä–∞–µ–º –Ω—É–∂–Ω–æ–µ —á–∏—Å–ª–æ —à–ø–∏–æ–Ω–æ–≤
        const spiesToPick = App.state.config.spies;
        const chosenSpyIds = candidates.slice(0, spiesToPick).map(p => p.id);
        // 5. –ü—Ä–æ—Å—Ç–∞–≤–ª—è–µ–º —Ä–æ–ª–∏ –∏ –≥–µ—Ä–æ—è
        App.state.players.forEach(p => {
          p.hero = hero;
          if(chosenSpyIds.includes(p.id)) {
            p.isSpy = true;
            p.spyStreak += 1;
          } else {
            p.isSpy = false;
            p.spyStreak = 0;
          }
        });
        App.state.phase = 'game';
        App.state.chat = [];  // –æ—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞ –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–∞—É–Ω–¥–∞
        Net.broadcast();
      },
      endRound: function() {
        App.state.phase = 'lobby';
        App.state.players.forEach(p => p.ready = false);
        App.state.chat = [];  // –æ—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞ –ø–æ—Å–ª–µ —Ä–∞—É–Ω–¥–∞ (–Ω–æ–≤—ã–π —á–∏—Å—Ç—ã–π –ª–æ–±–±–∏)
        Net.broadcast();
      },
      copyInvite: function() {
        const url = window.location.origin + window.location.pathname + '?code=' + App.state.roomCode;
        navigator.clipboard.writeText(url).then(() => alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"));
      },
      render: function() {
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        if(App.state.phase === 'menu') {
          document.getElementById('screen-menu').classList.add('active');
          // –ï—Å–ª–∏ –≤ URL –µ—Å—Ç—å –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã, –ø–æ–∫–∞–∑–∞—Ç—å –µ–≥–æ –≤ –ø–æ–ª–µ
          const params = new URLSearchParams(location.search);
          if(params.has('code')) document.getElementById('code-inp').value = params.get('code');
        } else if(App.state.phase === 'lobby') {
          document.getElementById('screen-lobby').classList.add('active');
          document.getElementById('lobby-code-display').innerText = App.state.roomCode;
          const isHost = App.me.isHost;
          // –ö–Ω–æ–ø–∫–∞ "–ù–∞—á–∞—Ç—å" –≤–∏–¥–Ω–∞ —Ç–æ–ª—å–∫–æ —Ö–æ—Å—Ç—É, –∞–∫—Ç–∏–≤–Ω–∞ –µ—Å–ª–∏ –≤—Å–µ –≥–æ—Ç–æ–≤—ã
          const startBtn = document.getElementById('btn-start');
          if(isHost) {
            startBtn.style.display = 'flex';
            const allReady = App.state.players.every(p => p.ready);
            startBtn.disabled = !allReady;
          } else {
            startBtn.style.display = 'none';
          }
          document.getElementById('host-settings-panel').style.display = isHost ? 'block' : 'none';
          const btnReady = document.getElementById('btn-ready');
          if(isHost) {
            btnReady.style.display = 'none';
          } else {
            btnReady.style.display = 'flex';
            const me = App.state.players.find(p => p.id === App.me.id);
            if(me) {
              btnReady.innerText = me.ready ? "–Ø –ù–ï –ì–û–¢–û–í" : "–Ø –ì–û–¢–û–í";
              btnReady.style.background = me.ready ? 'transparent' : '';
              btnReady.style.border = me.ready ? '1px solid #777' : '';
            }
          }
          // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∏–≥—Ä–æ–∫–æ–≤ –≤ –ª–æ–±–±–∏
          const list = document.getElementById('player-list-container');
          list.innerHTML = '';
          App.state.players.forEach(p => {
            list.innerHTML += `
              <div class="player-row ${p.ready ? 'ready' : ''}">
                <span>${p.name} ${p.id === App.me.id ? '(–í—ã)' : ''}</span>
                <span class="status-pill ${p.ready ? 'st-ready' : 'st-wait'}">
                  ${p.ready ? 'READY' : 'WAIT'}
                </span>
              </div>`;
          });
          this.renderChat('lobby');
        } else if(App.state.phase === 'game') {
          document.getElementById('screen-game').classList.add('active');
          this.prepareRoleCard();
          document.getElementById('host-end-btn').style.display = App.me.isHost ? 'flex' : 'none';
          this.renderChat('game');
        }
      },
      renderChat: function(ctx) {
        const box = document.getElementById(`chat-${ctx}`);
        box.innerHTML = '';
        App.state.chat.forEach(msg => {
          box.innerHTML += `<div class="msg"><b>${msg.name}:</b> ${msg.text}</div>`;
        });
        box.scrollTop = box.scrollHeight;
      },
      prepareRoleCard: function() {
        const me = App.state.players.find(p => p.id === App.me.id);
        if(!me) return;
        const card = document.getElementById('role-overlay');
        const icon = document.getElementById('role-icon');
        const hero = document.getElementById('role-text');
        const sub = document.getElementById('role-sub');
        if(me.isSpy) {
          card.classList.add('spy-mode');
          icon.innerText = "üòà";
          hero.innerText = "–¢–´ –®–ü–ò–û–ù";
          sub.innerText = "–°–∫—Ä–æ–π—Å—è –∏ —É–≥–∞–¥–∞–π –≥–µ—Ä–æ—è";
        } else {
          card.classList.remove('spy-mode');
          icon.innerText = "üõ°Ô∏è";
          hero.innerText = me.hero;      // —É –º–∏—Ä–Ω–æ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∏–º—è –≥–µ—Ä–æ—è
          sub.innerText = "–¢—ã –ú–∏—Ä–Ω—ã–π";
        }
      },
      // –ú–µ—Ö–∞–Ω–∏–∫–∞ —É–¥–µ—Ä–∂–∞–Ω–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —Ä–æ–ª–∏
      reveal: function(show) {
        const overlay = document.getElementById('role-overlay');
        const btn = document.getElementById('reveal-btn');
        if(show) {
          overlay.style.display = 'block';
          btn.style.opacity = 0.2;
        } else {
          overlay.style.display = 'none';
          btn.style.opacity = 1;
        }
      }
    };

    // --- –ü—Ä–æ—á–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ ---
    function triggerEasterEgg() {
      const el = document.getElementById('secret-modal');
      el.style.opacity = 1;
      el.style.zIndex = 9999;
      confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
      setTimeout(() => { el.style.opacity = 0; el.style.zIndex = -1; }, 2500);
    }

    // --- –°—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
    window.onload = function() {
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ —Å—Å—ã–ª–∫–∞ —Å –∫–æ–¥–æ–º –∫–æ–º–Ω–∞—Ç—ã, –≤—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –≤ –ø–æ–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
      const url = new URL(window.location.href);
      if(url.searchParams.has('code')) {
        document.getElementById('code-inp').value = url.searchParams.get('code');
      }
      // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter –≤ —á–∞—Ç–µ
      document.getElementById('chat-inp-lobby').addEventListener('keyup', (e) => {
        if(e.key === 'Enter') Game.sendChat('lobby');
      });
      document.getElementById('chat-inp-game').addEventListener('keyup', (e) => {
        if(e.key === 'Enter') Game.sendChat('game');
      });
    }
  </script>
</body>
</html>
