<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPY: v7 STABLE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #121212;
            --surface: #1e1e1e;
            --surface-2: #2c2c2c;
            --primary: #ffffff;
            --accent: #3b82f6;
            --danger: #ef4444;
            --success: #22c55e;
            --text: #e0e0e0;
            --text-secondary: #a0a0a0;
            --border: rgba(255,255,255,0.08);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 24px;
            max-width: 600px;
            margin: 0 auto;
            width: 100%;
        }
        .screen.active { display: flex; }

        h1 { font-weight: 800; font-size: 1.5rem; margin: 0 0 24px 0; letter-spacing: -0.5px; text-align: center; }

        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border);
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .label {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        input, select {
            width: 100%;
            padding: 16px;
            background: var(--surface-2);
            border: 1px solid transparent;
            color: white;
            font-family: inherit;
            font-size: 1rem;
            border-radius: 12px;
            margin-bottom: 16px;
            transition: 0.2s;
            text-align: center;
        }
        input:focus { border-color: var(--accent); background: #333; }

        .btn {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 12px;
            display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: var(--primary); color: black; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-danger { background: var(--surface-2); color: var(--danger); border: 1px solid var(--border); }
        .btn-ready { background: var(--surface-2); color: var(--text-secondary); }
        .btn-ready.is-ready { background: var(--success); color: black; }
        .btn-ghost { background: transparent; color: var(--text-secondary); }

        /* LOBBY */
        .room-code {
            font-size: 3rem;
            font-weight: 800;
            text-align: center;
            letter-spacing: 8px;
            color: var(--primary);
            margin: 10px 0;
            user-select: text; /* –ß—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å */
        }

        .player-list {
            flex-grow: 1; overflow-y: auto; margin: 16px 0; padding-right: 4px;
        }
        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 16px; background: var(--surface); border-radius: 12px;
            margin-bottom: 8px; border: 1px solid var(--border);
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .dot.active { background: var(--success); box-shadow: 0 0 8px var(--success); }

        /* GAME */
        .role-wrapper {
            flex-grow: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: center; position: relative;
        }

        .reveal-btn {
            width: 220px; height: 220px; border-radius: 50%;
            background: var(--surface); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; color: var(--text-secondary); font-weight: 600;
            cursor: pointer; user-select: none;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; padding: 20px;
            transition: 0.2s;
            -webkit-touch-callout: none;
        }
        .reveal-btn:active { transform: scale(0.95); background: var(--surface-2); }
        .reveal-btn > * { pointer-events: none; }

        .role-card {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); width: 280px;
            background: #fff; color: #000; border-radius: 20px;
            padding: 30px; text-align: center; z-index: 20;
            pointer-events: none; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .role-card.spy { background: var(--danger); color: white; }
        .role-icon { font-size: 3rem; margin-bottom: 10px; }
        .role-name { font-size: 1.5rem; font-weight: 800; margin-bottom: 5px; }
        .role-desc { font-size: 0.9rem; opacity: 0.7; }

        /* CHAT */
        .chat-box {
            height: 150px; display: flex; flex-direction: column;
            background: var(--surface); border-radius: 12px;
            overflow: hidden; border: 1px solid var(--border);
        }
        .chat-history { flex-grow: 1; overflow-y: auto; padding: 12px; font-size: 0.9rem; }
        .chat-msg { margin-bottom: 4px; }
        .chat-msg b { color: var(--text); font-weight: 600; margin-right: 6px; }
        .chat-input-area { display: flex; border-top: 1px solid var(--border); }
        .chat-inp {
            flex-grow: 1; background: transparent; border: none; padding: 12px;
            color: white; font-size: 0.9rem; margin: 0; text-align: left;
        }
        .chat-send { background: var(--surface-2); border: none; color: white; width: 50px; cursor: pointer; }

        /* EXTRAS */
        .footer { margin-top: auto; text-align: center; padding: 10px; font-size: 0.8rem; color: var(--text-secondary); cursor: pointer; }
        .heart { display: inline-block; transition: transform 0.2s; color: #555; }
        .heart:hover { color: var(--danger); transform: scale(1.2); }
        .secret-popup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8); padding: 20px 40px; border-radius: 50px;
            color: white; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.5s; z-index: 999;
        }
        .secret-popup.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="secret-popup" class="secret-popup">–Ø –ª—é–±–ª—é –°–æ–Ω—é ‚ù§Ô∏è</div>

    <!-- 1. MENU -->
    <div id="screen-menu" class="screen active">
        <h1 style="color: var(--text);">Spy Game</h1>
        
        <div class="card">
            <div class="label">–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º</div>
            <input type="text" id="inp-nickname" placeholder="–ò–º—è">
        </div>

        <div class="card" style="border:none; background:transparent; padding:0; box-shadow:none;">
            <button id="btn-create-lobby" class="btn btn-primary" onclick="Game.createLobby()">–°–æ–∑–¥–∞—Ç—å –∏–≥—Ä—É</button>
            <div style="text-align:center; margin:15px; color:var(--text-secondary); font-size:0.8rem;">–∏–ª–∏</div>
            <input type="text" id="inp-code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (4 —Å–∏–º–≤–æ–ª–∞)" style="margin-bottom:8px;">
            <button id="btn-join-lobby" class="btn btn-accent" onclick="Game.joinLobby()">–í–æ–π—Ç–∏</button>
        </div>
        
        <div class="footer" onclick="activateSecret()">
            v7.0 Stable ‚Ä¢ <span class="heart">‚ù§Ô∏è</span>
        </div>
    </div>

    <!-- 2. LOBBY -->
    <div id="screen-lobby" class="screen">
        <div class="label" style="text-align:center;">–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã</div>
        <div class="room-code" id="lobby-code-disp">----</div>

        <div id="host-settings" style="display:none; margin-bottom: 20px;">
            <div style="display:flex; gap:10px;">
                <select id="sel-spies" onchange="Game.updateSettings()">
                    <option value="1">1 –®–ø–∏–æ–Ω</option>
                    <option value="2">2 –®–ø–∏–æ–Ω–∞</option>
                </select>
                <select id="sel-pack" onchange="Game.updateSettings()">
                    <option value="mix">–í—Å–µ –∏–≥—Ä—ã</option>
                    <option value="dota">Dota 2</option>
                    <option value="clash">Clash</option>
                </select>
            </div>
        </div>

        <div class="label">–ò–≥—Ä–æ–∫–∏</div>
        <div class="player-list" id="lobby-list"></div>

        <button id="btn-ready" class="btn btn-ready" onclick="Game.toggleReady()">–ì–æ—Ç–æ–≤</button>
        <button id="btn-start" class="btn btn-primary" onclick="Game.hostStart()" style="display:none;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>

        <div class="chat-box">
            <div class="chat-history" id="lobby-chat"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-inp" id="lobby-chat-inp" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å...">
                <button class="chat-send" onclick="Game.sendChat('lobby')">‚û§</button>
            </div>
        </div>
    </div>

    <!-- 3. GAME -->
    <div id="screen-game" class="screen">
        <div class="role-wrapper">
            <div class="reveal-btn" id="reveal-btn"
                 onmousedown="Game.showRole(event)" 
                 onmouseup="Game.hideRole(event)"
                 onmouseleave="Game.hideRole(event)"
                 ontouchstart="Game.showRole(event)" 
                 ontouchend="Game.hideRole(event)"
                 ontouchcancel="Game.hideRole(event)">
                <span>–£–¥–µ—Ä–∂–∏–≤–∞–π,<br>—á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å</span>
            </div>

            <div id="role-card" class="role-card">
                <div id="role-icon" class="role-icon"></div>
                <div id="role-name" class="role-name"></div>
                <div id="role-desc" class="role-desc"></div>
            </div>
        </div>

        <div style="margin-bottom: 20px;">
             <button class="btn btn-danger" onclick="alert('–û–±—Å—É–¥–∏—Ç–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —à–ø–∏–æ–Ω–∞ –≤—Å–ª—É—Ö!')">–í—ã–∑–≤–∞—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</button>
        </div>

        <div class="chat-box">
            <div class="chat-history" id="game-chat"></div>
            <div class="chat-input-area">
                <input type="text" class="chat-inp" id="game-chat-inp" placeholder="–û–±—Å—É–∂–¥–µ–Ω–∏–µ...">
                <button class="chat-send" onclick="Game.sendChat('game')">‚û§</button>
            </div>
        </div>
        
        <button class="btn btn-ghost" onclick="Game.endGame()" id="host-end-btn" style="display:none; margin-top:10px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É</button>
    </div>

    <script>
        const DB = {
            dota: ["Pudge", "Invoker", "Juggernaut", "CM", "Techies", "Sniper", "Axe", "SF", "Anti-Mage", "Lion", "Zeus", "Riki", "Roshan"],
            clash: ["P.E.K.K.A", "Hog Rider", "Mega Knight", "Golem", "Giant", "Miner", "Princess", "Wizard", "Valkyrie", "Goblin Barrel"],
            brawl: ["Shelly", "Colt", "El Primo", "Leon", "Spike", "Crow", "Mortis"]
        };

        const Game = {
            peer: null, conn: null, myId: null, myName: '', isHost: false, roomCode: '',
            hostConnections: [],
            state: { phase: 'menu', players: [], chat: [], settings: { spies: 1, pack: 'mix' } },

            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                if(id === 'screen-lobby') this.renderChat('lobby');
                if(id === 'screen-game') this.renderChat('game');
            },

            // --- PEERJS LOGIC ---
            createLobby: function() {
                const btn = document.getElementById('btn-create-lobby');
                btn.innerText = "–°–æ–∑–¥–∞–Ω–∏–µ...";
                btn.disabled = true;

                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ –∏ ID
                this.roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º v7 –ø—Ä–µ—Ñ–∏–∫—Å –¥–ª—è –∏–∑–æ–ª—è—Ü–∏–∏ –æ—Ç —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π
                this.myId = `spy-party-v7-${this.roomCode}`;
                this.isHost = true;
                this.myName = document.getElementById('inp-nickname').value.trim() || "Admin";
                
                this.initPeer();
            },

            joinLobby: function() {
                const btn = document.getElementById('btn-join-lobby');
                btn.innerText = "–í—Ö–æ–¥...";
                btn.disabled = true;

                const code = document.getElementById('inp-code').value.trim().toUpperCase();
                if(code.length !== 4) {
                    btn.innerText = "–í–æ–π—Ç–∏"; btn.disabled = false;
                    return alert("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 —Å–∏–º–≤–æ–ª–∞");
                }
                
                this.roomCode = code;
                this.myId = `spy-player-v7-${Date.now()}`;
                this.isHost = false;
                this.myName = document.getElementById('inp-nickname').value.trim() || "Player";
                
                this.initPeer();
            },

            initPeer: function() {
                if (this.peer) this.peer.destroy();
                this.peer = new Peer(this.myId);

                this.peer.on('open', (id) => {
                    console.log('Connected to PeerJS server:', id);
                    if (this.isHost) {
                        this.state.players = [{ id: this.myId, name: this.myName, ready: true }];
                        this.state.phase = 'lobby';
                        this.showScreen('screen-lobby');
                        this.renderLobby();
                    } else {
                        // –ö–æ–Ω–Ω–µ–∫—Ç –∫ —Ö–æ—Å—Ç—É
                        this.conn = this.peer.connect(`spy-party-v7-${this.roomCode}`);
                        
                        this.conn.on('open', () => {
                            this.conn.send({ type: 'JOIN', id: this.myId, name: this.myName });
                        });
                        
                        this.conn.on('data', (data) => {
                            if(data.type === 'SYNC') {
                                this.state = data.state;
                                this.renderApp();
                            }
                        });

                        this.conn.on('close', () => { 
                            alert("–•–æ—Å—Ç –≤—ã—à–µ–ª"); location.reload(); 
                        });

                        // –¢–∞–π–º–∞—É—Ç –µ—Å–ª–∏ —Ö–æ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
                        setTimeout(() => {
                            if(!this.conn.open) {
                                alert("–õ–æ–±–±–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ! –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥.");
                                location.reload();
                            }
                        }, 5000);
                    }
                });

                this.peer.on('error', err => {
                    console.error(err);
                    if(this.isHost && err.type === 'unavailable-id') {
                        // –ï—Å–ª–∏ ID –∑–∞–Ω—è—Ç, –ø—Ä–æ–±—É–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–æ–¥
                        this.peer.destroy();
                        this.roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
                        this.myId = `spy-party-v7-${this.roomCode}`;
                        this.initPeer(); // –†–µ–∫—É—Ä—Å–∏—è
                    } else {
                        alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.type);
                        location.reload();
                    }
                });

                if (this.isHost) {
                    this.peer.on('connection', (conn) => {
                        this.hostConnections.push(conn);
                        conn.on('data', (data) => this.handleHostData(data));
                        conn.on('close', () => {
                            this.hostConnections = this.hostConnections.filter(c => c !== conn);
                            this.state.players = this.state.players.filter(p => p.id !== conn.peer);
                            this.broadcast();
                        });
                        conn.on('open', () => conn.send({ type: 'SYNC', state: this.state }));
                    });
                }
            },

            // --- HOST DATA HANDLER ---
            handleHostData: function(data) {
                let update = false;
                if(data.type === 'JOIN') {
                    if(!this.state.players.find(p => p.id === data.id)) {
                        this.state.players.push({ id: data.id, name: data.name, ready: false });
                        update = true;
                    }
                }
                if(data.type === 'READY') {
                    const p = this.state.players.find(p => p.id === data.id);
                    if(p) { p.ready = !p.ready; update = true; }
                }
                if(data.type === 'CHAT') {
                    this.state.chat.push(data.msg);
                    if(this.state.chat.length > 30) this.state.chat.shift();
                    update = true;
                }
                if(update) this.broadcast();
            },

            broadcast: function() {
                this.renderApp();
                this.hostConnections.forEach(c => {
                    if(c.open) c.send({ type: 'SYNC', state: this.state });
                });
            },

            updateSettings: function() {
                this.state.settings.spies = parseInt(document.getElementById('sel-spies').value);
                this.state.settings.pack = document.getElementById('sel-pack').value;
                this.broadcast();
            },

            // --- GAME ACTIONS ---
            toggleReady: function() {
                if(this.isHost) return;
                this.conn.send({ type: 'READY', id: this.myId });
            },

            sendChat: function(ctx) {
                const inp = document.getElementById(ctx + '-chat-inp');
                const text = inp.value.trim();
                if(!text) return;
                const msg = { name: this.myName, text: text };
                
                if(this.isHost) {
                    this.state.chat.push(msg);
                    this.broadcast();
                } else {
                    this.conn.send({ type: 'CHAT', msg: msg });
                }
                inp.value = '';
            },

            hostStart: function() {
                if(this.state.players.length < 3) return alert("–ú–∏–Ω–∏–º—É–º 3 –∏–≥—Ä–æ–∫–∞!");
                
                let indices = this.state.players.map((_, i) => i);
                // Shuffle logic (Fisher-Yates)
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }

                let pool = [];
                const pack = this.state.settings.pack;
                if(pack === 'mix') pool = [...DB.dota, ...DB.clash, ...DB.brawl];
                else pool = DB[pack];
                const loc = pool[Math.floor(Math.random() * pool.length)];

                const spyCount = this.state.settings.spies;
                this.state.players.forEach((p, idx) => {
                    const isSpy = indices.indexOf(idx) < spyCount;
                    p.isSpy = isSpy;
                    p.location = loc;
                });

                this.state.phase = 'game';
                this.state.chat = [];
                this.broadcast();
            },
            
            endGame: function() {
                this.state.phase = 'lobby';
                this.state.players.forEach(p => p.ready = false);
                this.broadcast();
            },

            // --- RENDERING ---
            renderApp: function() {
                if(this.state.phase === 'lobby') {
                    this.showScreen('screen-lobby');
                    this.renderLobby();
                } else if(this.state.phase === 'game') {
                    this.showScreen('screen-game');
                    this.renderGameRole();
                }
            },

            renderLobby: function() {
                document.getElementById('lobby-code-disp').innerText = this.roomCode;
                const list = document.getElementById('lobby-list');
                list.innerHTML = '';
                this.state.players.forEach(p => {
                    list.innerHTML += `
                        <div class="player-item">
                            <span>${p.name} ${p.id === this.myId ? '(–í—ã)' : ''}</span>
                            <div class="dot ${p.ready ? 'active' : ''}"></div>
                        </div>`;
                });

                if(this.isHost) {
                    document.getElementById('host-settings').style.display = 'block';
                    document.getElementById('btn-start').style.display = 'block';
                    document.getElementById('btn-ready').style.display = 'none';
                } else {
                    document.getElementById('host-settings').style.display = 'none';
                    document.getElementById('btn-start').style.display = 'none';
                    const btn = document.getElementById('btn-ready');
                    btn.style.display = 'block';
                    const me = this.state.players.find(p => p.id === this.myId);
                    if(me && me.ready) {
                        btn.innerText = "–ù–µ –≥–æ—Ç–æ–≤";
                        btn.classList.add('is-ready');
                    } else {
                        btn.innerText = "–ì–æ—Ç–æ–≤";
                        btn.classList.remove('is-ready');
                    }
                }
                this.renderChat('lobby');
            },

            renderChat: function(ctx) {
                const box = document.getElementById(ctx + '-chat');
                box.innerHTML = '';
                this.state.chat.forEach(m => {
                    box.innerHTML += `<div class="chat-msg"><b>${m.name}:</b><span>${m.text}</span></div>`;
                });
                box.scrollTop = box.scrollHeight;
            },

            renderGameRole: function() {
                const me = this.state.players.find(p => p.id === this.myId);
                const card = document.getElementById('role-card');
                const icon = document.getElementById('role-icon');
                const name = document.getElementById('role-name');
                const desc = document.getElementById('role-desc');
                const endBtn = document.getElementById('host-end-btn');

                endBtn.style.display = this.isHost ? 'block' : 'none';

                if(me.isSpy) {
                    card.classList.add('spy');
                    icon.innerText = "üïµÔ∏è‚Äç‚ôÇÔ∏è";
                    name.innerText = "–¢–´ –®–ü–ò–û–ù";
                    desc.innerText = "–ù–µ —Å–ø–∞–ª–∏—Å—å!";
                } else {
                    card.classList.remove('spy');
                    icon.innerText = "üõ°Ô∏è";
                    name.innerText = me.location;
                    desc.innerText = "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å";
                }
            },

            showRole: function(e) {
                if(e.cancelable) e.preventDefault();
                const card = document.getElementById('role-card');
                const btn = document.getElementById('reveal-btn');
                card.style.display = 'block';
                btn.style.opacity = '0.3';
                btn.style.transform = 'scale(0.95)';
            },

            hideRole: function(e) {
                if(e && e.cancelable) e.preventDefault();
                const card = document.getElementById('role-card');
                const btn = document.getElementById('reveal-btn');
                card.style.display = 'none';
                btn.style.opacity = '1';
                btn.style.transform = 'scale(1)';
            }
        };

        function activateSecret() {
            const popup = document.getElementById('secret-popup');
            popup.classList.add('show');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            setTimeout(() => popup.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
