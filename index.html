<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOTA SPY GAME</title>
    
    <!-- Modern Font -->
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #09090b; /* Very dark slate */
            --surface: #18181b;
            --surface-hover: #27272a;
            --primary: #f59e0b; /* Amber/Dota Gold */
            --primary-glow: rgba(245, 158, 11, 0.4);
            --danger: #ef4444;
            --spy-color: #dc2626;
            --citizen-color: #2563eb;
            --text: #f4f4f5;
            --text-dim: #71717a;
            --border: #3f3f46;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        body {
            margin: 0; background: var(--bg); color: var(--text);
            font-family: 'Manrope', sans-serif;
            height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- SCREEN MANAGING --- */
        .screen {
            display: none; height: 100%; flex-direction: column;
            padding: 20px; max-width: 600px; margin: 0 auto; width: 100%;
        }
        .screen.active { display: flex; }

        h1 {
            text-align: center; font-weight: 800; text-transform: uppercase;
            letter-spacing: 2px; color: var(--primary); text-shadow: 0 0 15px var(--primary-glow);
            margin-bottom: 30px;
        }

        /* --- UI CARDS --- */
        .card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 16px; padding: 24px; margin-bottom: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.5);
        }

        .input-group { margin-bottom: 16px; }
        label { display: block; font-size: 0.75rem; color: var(--text-dim); margin-bottom: 8px; font-weight: 600; letter-spacing: 0.5px;}
        
        input, select {
            width: 100%; padding: 16px; background: #000; border: 1px solid var(--border);
            color: white; font-family: inherit; font-size: 1rem; border-radius: 12px;
            text-align: center; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-weight: 700; font-size: 1rem; cursor: pointer; text-transform: uppercase;
            transition: all 0.2s; margin-bottom: 12px; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-glow); }
        .btn-outline { background: transparent; border: 1px solid var(--text-dim); color: var(--text); }
        .btn-danger { background: rgba(220, 38, 38, 0.1); border: 1px solid var(--danger); color: var(--danger); }
        .btn-ghost { background: transparent; color: var(--text-dim); font-size: 0.8rem; }
        .btn-link { background: var(--surface-hover); color: var(--text); border: 1px solid var(--border); font-size: 0.9rem;}

        /* --- LOBBY UI --- */
        .room-code-display {
            font-size: 3.5rem; font-weight: 800; text-align: center;
            letter-spacing: 8px; color: var(--text);
            font-variant-numeric: tabular-nums;
            margin: 10px 0;
            user-select: text;
        }
        
        .player-list { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; border: 1px solid var(--border); }
        .player-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: var(--surface); border-radius: 8px;
            margin-bottom: 8px; transition: 0.2s;
        }
        .player-row.ready { border-left: 3px solid var(--primary); }
        
        .status-pill {
            font-size: 0.7rem; padding: 4px 8px; border-radius: 20px; font-weight: 700; text-transform: uppercase;
        }
        .st-wait { background: #27272a; color: #71717a; }
        .st-ready { background: var(--primary); color: #000; }

        /* --- GAME UI --- */
        .role-wrapper {
            flex: 1; display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }
        
        .role-reveal-btn {
            width: 240px; height: 240px; border-radius: 50%;
            background: linear-gradient(145deg, #18181b, #09090b);
            border: 2px solid var(--border);
            box-shadow: 20px 20px 60px #050506, -20px -20px 60px #1d1d20;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center; color: var(--text-dim); font-weight: 700;
            transition: 0.1s; cursor: pointer;
            -webkit-user-select: none;
        }
        .role-reveal-btn:active { transform: scale(0.95); background: #000; color: #555; border-color: #222; }
        
        .role-content {
            display: none; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 280px; padding: 30px; border-radius: 24px;
            background: #fff; color: #000; text-align: center;
            pointer-events: none; z-index: 100;
            box-shadow: 0 0 100px rgba(0,0,0,0.8);
        }
        .role-content.spy-mode { background: var(--spy-color); color: #fff; }
        .role-icon { font-size: 3rem; margin-bottom: 10px; }
        .role-hero { font-size: 1.8rem; font-weight: 800; line-height: 1.2; margin-bottom: 5px; }
        .role-sub { font-size: 0.9rem; opacity: 0.8; font-weight: 600; text-transform: uppercase;}

        /* --- CHAT --- */
        .chat-section {
            height: 160px; display: flex; flex-direction: column;
            border-top: 1px solid var(--border); padding-top: 10px;
        }
        .chat-history {
            flex: 1; overflow-y: auto; padding: 5px; font-size: 0.9rem;
            display: flex; flex-direction: column; gap: 4px;
        }
        .msg { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .msg b { color: var(--primary); margin-right: 5px; }
        
        .chat-form { display: flex; gap: 8px; margin-top: 10px; }
        .chat-inp {
            flex: 1; padding: 12px; border-radius: 8px; 
            background: #000; border: 1px solid var(--border); color: #fff;
            text-align: left;
        }
        .chat-btn { width: 50px; background: var(--surface-hover); border: none; color: var(--primary); border-radius: 8px; cursor: pointer;}

        /* --- CONNECTION STATUS --- */
        #conn-status {
            position: fixed; bottom: 5px; left: 0; width: 100%;
            text-align: center; font-size: 0.7rem; color: #333;
            pointer-events: none;
        }
        
        /* Easter Egg */
        .easter-egg-zone { position: fixed; top: 0; left: 0; width: 20px; height: 20px; z-index: 1000; }
    </style>
</head>
<body>

    <div id="secret-modal" style="position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); color:#ec4899; font-size:1.5rem; font-weight:bold; opacity:0; pointer-events:none; transition:0.5s;">–Ø –ª—é–±–ª—é –°–æ–Ω—é ‚ù§Ô∏è</div>
    <div class="easter-egg-zone" onclick="triggerEasterEgg()"></div>

    <!-- 1. MENU -->
    <div id="screen-menu" class="screen active">
        <h1>Spy Game</h1>
        <div class="card">
            <div class="input-group">
                <label>–ù–ò–ö–ù–ï–ô–ú</label>
                <input type="text" id="nick-inp" placeholder="–¢–≤–æ–µ –∏–º—è">
            </div>
            
            <button class="btn btn-primary" onclick="Net.host()">–°–æ–∑–¥–∞—Ç—å –ª–æ–±–±–∏</button>
            
            <div style="height: 1px; background: var(--border); margin: 20px 0;"></div>
            
            <div class="input-group">
                <label>–ö–û–î –ö–û–ú–ù–ê–¢–´ (4 –ë–£–ö–í–´)</label>
                <input type="text" id="code-inp" placeholder="XXXX" style="letter-spacing: 5px; text-transform: uppercase;">
            </div>
            <button class="btn btn-outline" onclick="Net.join()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
        <p style="text-align:center; color:#333; font-size:0.8rem; margin-top:auto;">v9.0 | No more limits</p>
    </div>

    <!-- 2. LOBBY -->
    <div id="screen-lobby" class="screen">
        <div class="card" style="text-align:center;">
            <label>–ö–û–î –î–õ–Ø –í–•–û–î–ê</label>
            <div class="room-code-display" id="lobby-code-display">....</div>
            <button class="btn btn-link" onclick="Game.copyInvite()">üîó –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            
            <div id="host-settings-panel" style="margin-top:15px; display:none;">
                <label>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à–ø–∏–æ–Ω–æ–≤</label>
                <select id="spy-count" onchange="Game.sendSettings()">
                    <option value="1">1 –®–ø–∏–æ–Ω</option>
                    <option value="2">2 –®–ø–∏–æ–Ω–∞</option>
                    <option value="3">3 –®–ø–∏–æ–Ω–∞ (–•–∞–æ—Å)</option>
                </select>
            </div>
        </div>

        <label style="padding: 0 4px;">–ò–ì–†–û–ö–ò –û–ù–õ–ê–ô–ù</label>
        <div class="player-list" id="player-list-container">
            <!-- JS inserts players -->
        </div>

        <div style="margin-top: 15px;">
            <button id="btn-ready" class="btn btn-outline" onclick="Game.toggleReady()">–ì–û–¢–û–í</button>
            <button id="btn-start" class="btn btn-primary" onclick="Game.startGame()" style="display:none;">–ù–ê–ß–ê–¢–¨ –†–ê–£–ù–î</button>
        </div>

        <!-- Chat Area -->
        <div class="chat-section">
            <div class="chat-history" id="chat-lobby"></div>
            <div class="chat-form">
                <input type="text" class="chat-inp" id="chat-inp-lobby" placeholder="–ß–∞—Ç...">
                <button class="chat-btn" onclick="Game.sendChat('lobby')">‚û§</button>
            </div>
        </div>
    </div>

    <!-- 3. GAME -->
    <div id="screen-game" class="screen">
        <div class="role-wrapper">
            <!-- –ö–ù–û–ü–ö–ê –ü–û–ö–ê–ó–ê (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –º–µ—Ö–∞–Ω–∏–∫–∞) -->
            <div class="role-reveal-btn" id="reveal-btn"
                onmousedown="Game.reveal(true)" onmouseup="Game.reveal(false)"
                onmouseleave="Game.reveal(false)"
                ontouchstart="Game.reveal(true)" ontouchend="Game.reveal(false)"
                ontouchcancel="Game.reveal(false)">
                <span style="pointer-events: none;">–£–î–ï–†–ñ–ò–í–ê–ô<br>–ß–¢–û–ë–´<br>–£–ó–ù–ê–¢–¨ –†–û–õ–¨</span>
            </div>

            <!-- –°–∞–º–∞ —Ä–æ–ª—å -->
            <div id="role-overlay" class="role-content">
                <div id="role-icon" class="role-icon"></div>
                <div id="role-text" class="role-hero"></div>
                <div id="role-sub" class="role-sub"></div>
            </div>
        </div>

        <div class="card">
             <button class="btn btn-danger" onclick="alert('–û–±—Å—É–¥–∏—Ç–µ –≥–æ–ª–æ—Å–æ–º –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —à–ø–∏–æ–Ω–∞!')">üö® –í–´–ó–í–ê–¢–¨ –ì–û–õ–û–°–û–í–ê–ù–ò–ï</button>
             <button id="host-end-btn" class="btn btn-ghost" onclick="Game.endRound()" style="display:none; margin-bottom:0;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É (–•–æ—Å—Ç)</button>
        </div>

        <!-- Chat Area -->
        <div class="chat-section" style="height: 120px;">
            <div class="chat-history" id="chat-game"></div>
            <div class="chat-form">
                <input type="text" class="chat-inp" id="chat-inp-game" placeholder="–û–±—Å—É–∂–¥–µ–Ω–∏–µ...">
                <button class="chat-btn" onclick="Game.sendChat('game')">‚û§</button>
            </div>
        </div>
    </div>

    <div id="conn-status">–û–∂–∏–¥–∞–Ω–∏–µ...</div>

    <script>
        // --- DATA ---
        // –ü–æ–ª–Ω—ã–π —Å–ø–∏—Å–æ–∫, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –ø—Ä–æ—Å–∏–ª
        const DOTA_HEROES = [
            "Abaddon", "Alchemist", "Ancient Apparition", "Anti-Mage", "Arc Warden", "Axe", "Bane", "Batrider", 
            "Beastmaster", "Bloodseeker", "Bounty Hunter", "Brewmaster", "Bristleback", "Broodmother", 
            "Centaur Warrunner", "Chaos Knight", "Chen", "Clinkz", "Clockwerk", "Crystal Maiden", "Dark Seer", 
            "Dark Willow", "Dawnbreaker", "Dazzle", "Death Prophet", "Disruptor", "Doom", "Dragon Knight", 
            "Drow Ranger", "Earth Spirit", "Earthshaker", "Elder Titan", "Ember Spirit", "Enchantress", "Enigma", 
            "Faceless Void", "Grimstroke", "Gyrocopter", "Hoodwink", "Huskar", "Invoker", "Io", "Jakiro", 
            "Juggernaut", "Keeper of the Light", "Kunkka", "Legion Commander", "Leshrac", "Lich", "Lifestealer", 
            "Lina", "Lion", "Lone Druid", "Luna", "Lycan", "Magnus", "Marci", "Mars", "Medusa", "Meepo", "Mirana", 
            "Monkey King", "Morphling", "Muerta", "Naga Siren", "Nature‚Äôs Prophet", "Necrophos", "Night Stalker", 
            "Nyx Assassin", "Ogre Magi", "Omniknight", "Oracle", "Outworld Destroyer", "Pangolier", "Phantom Assassin", 
            "Phantom Lancer", "Phoenix", "Puck", "Pudge", "Pugna", "Queen of Pain", "Razor", "Riki", "Rubick", 
            "Sand King", "Shadow Demon", "Shadow Fiend", "Shadow Shaman", "Silencer", "Skywrath Mage", "Slardar", 
            "Slark", "Snapfire", "Sniper", "Spectre", "Spirit Breaker", "Storm Spirit", "Sven", "Techies", 
            "Templar Assassin", "Terrorblade", "Tidehunter", "Timbersaw", "Tinker", "Tiny", "Treant Protector", 
            "Troll Warlord", "Tusk", "Underlord", "Undying", "Ursa", "Vengeful Spirit", "Venomancer", "Viper", 
            "Visage", "Void Spirit", "Warlock", "Weaver", "Windranger", "Winter Wyvern", "Witch Doctor", 
            "Wraith King", "Zeus"
        ];

        // --- GLOBAL APP STATE ---
        const App = {
            state: {
                phase: 'menu',      // menu, lobby, game
                roomCode: '',
                players: [],        // Array of {id, name, ready, isSpy, hero, spyStreak}
                chat: [],
                config: { spies: 1 }
            },
            me: { id: null, name: '', isHost: false },
            hostData: { 
                conns: [], // –°–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –¥–ª—è —Ö–æ—Å—Ç–∞
                hero: ''   // –¢–µ–∫—É—â–∞—è –ª–æ–∫–∞—Ü–∏—è (–≥–µ—Ä–æ–π) –¥–ª—è —Ö–æ—Å—Ç–∞
            }
        };

        // --- NETWORKING ENGINE ---
        const Net = {
            peer: null,
            conn: null,

            log: (txt) => {
                document.getElementById('conn-status').innerText = txt;
                console.log("[Net]", txt);
            },

            // Create Lobby
            host: function() {
                App.me.name = document.getElementById('nick-inp').value.trim() || "Host";
                App.me.isHost = true;
                
                // Generate a guaranteed unique ID based on a 4-char code
                const code = this.generateCode();
                App.state.roomCode = code;
                
                // IMPORTANT: PeerID includes the Code
                const peerId = `spy-game-v9-${code}`; 

                this.log("Creating server: " + code);
                this.initPeer(peerId);
            },

            // Join Lobby
            join: function() {
                App.me.name = document.getElementById('nick-inp').value.trim() || "Player";
                App.me.isHost = false;
                
                const code = document.getElementById('code-inp').value.trim().toUpperCase();
                if(code.length !== 4) return alert("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–∑ 4 –±—É–∫–≤");

                // Client ID is random
                const peerId = `spy-client-${Math.random().toString(36).substr(2, 9)}`;
                this.initPeer(peerId, code);
            },

            initPeer: function(id, targetCode = null) {
                if(this.peer) this.peer.destroy();
                
                this.peer = new Peer(id);

                this.peer.on('open', (myId) => {
                    App.me.id = myId;
                    this.log("Online. ID: " + myId);

                    if(App.me.isHost) {
                        // Init State
                        App.state.players = [{ 
                            id: myId, name: App.me.name, ready: true, 
                            isSpy: false, spyStreak: 0 
                        }];
                        Game.enterLobby();
                    } else {
                        // Connect to Host
                        const hostId = `spy-game-v9-${targetCode}`;
                        this.connectToHost(hostId);
                    }
                });

                this.peer.on('error', (err) => {
                    console.error(err);
                    if(err.type === 'unavailable-id') {
                        if(App.me.isHost) {
                            alert("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–º–Ω–∞—Ç—ã (ID –∑–∞–Ω—è—Ç). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
                            location.reload(); // Hard retry
                        }
                    } else if (err.type === 'peer-unavailable') {
                        alert("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥.");
                        this.log("Host not found");
                    } else {
                        alert("Network Error: " + err.type);
                    }
                });

                // HOST: Handle incoming connections
                if(App.me.isHost) {
                    this.peer.on('connection', (c) => {
                        App.hostData.conns.push(c);
                        
                        c.on('data', (data) => this.handleDataAsHost(data, c.peer));
                        
                        c.on('close', () => {
                            App.hostData.conns = App.hostData.conns.filter(x => x !== c);
                            App.state.players = App.state.players.filter(p => p.id !== c.peer);
                            this.broadcast();
                        });

                        // Sync state immediately
                        c.on('open', () => c.send({ type: 'SYNC', state: App.state }));
                    });
                }
            },

            connectToHost: function(hostId) {
                this.log("Connecting to " + hostId);
                this.conn = this.peer.connect(hostId);
                
                this.conn.on('open', () => {
                    this.log("Connected to Host");
                    this.conn.send({ type: 'JOIN', name: App.me.name });
                });

                this.conn.on('data', (data) => {
                    if(data.type === 'SYNC') {
                        App.state = data.state;
                        Game.render();
                    }
                });

                this.conn.on('close', () => {
                    alert("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Ö–æ—Å—Ç–æ–º –ø–æ—Ç–µ—Ä—è–Ω–æ.");
                    location.reload();
                });
            },

            // --- DATA HANDLERS ---
            
            // Runs only on HOST
            handleDataAsHost: function(data, peerId) {
                let changed = false;

                if(data.type === 'JOIN') {
                    // Check duplicates
                    if(!App.state.players.find(p => p.id === peerId)) {
                        App.state.players.push({
                            id: peerId, name: data.name, 
                            ready: false, isSpy: false, spyStreak: 0
                        });
                        changed = true;
                    }
                }
                if(data.type === 'READY') {
                    const p = App.state.players.find(x => x.id === peerId);
                    if(p) { p.ready = !p.ready; changed = true; }
                }
                if(data.type === 'CHAT') {
                    this.pushChat(data.msg);
                    changed = true;
                }

                if(changed) this.broadcast();
            },

            pushChat: function(msg) {
                App.state.chat.push(msg);
                if(App.state.chat.length > 50) App.state.chat.shift();
            },

            // Host sends state to everyone
            broadcast: function() {
                Game.render(); // update self
                App.hostData.conns.forEach(c => {
                    if(c.open) c.send({ type: 'SYNC', state: App.state });
                });
            },

            generateCode: function() {
                const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
                let res = "";
                for(let i=0; i<4; i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
                return res;
            }
        };

        // --- GAME LOGIC ---
        const Game = {
            
            enterLobby: function() {
                App.state.phase = 'lobby';
                Net.broadcast(); // Or render if not broadcast needed yet
            },

            toggleReady: function() {
                if(App.me.isHost) return;
                Net.conn.send({ type: 'READY' });
            },

            sendChat: function(ctx) {
                const el = document.getElementById(`chat-inp-${ctx}`);
                const text = el.value.trim();
                if(!text) return;
                
                const msg = { name: App.me.name, text: text };
                
                if(App.me.isHost) {
                    Net.pushChat(msg);
                    Net.broadcast();
                } else {
                    Net.conn.send({ type: 'CHAT', msg: msg });
                }
                el.value = '';
            },
            
            sendSettings: function() {
                if(!App.me.isHost) return;
                App.state.config.spies = parseInt(document.getElementById('spy-count').value);
                Net.broadcast();
            },

            // --- CORE SPY LOGIC WITH ANTI-STREAK ---
            startGame: function() {
                const count = App.state.players.length;
                if(count < 3) return alert("–ú–∏–Ω–∏–º—É–º 3 –∏–≥—Ä–æ–∫–∞!");

                // 1. Pick Hero
                const hero = DOTA_HEROES[Math.floor(Math.random() * DOTA_HEROES.length)];

                // 2. Decide who can be spy (Anti-Streak logic)
                // Filter players who have spyStreak < 3
                let candidates = App.state.players.filter(p => p.spyStreak < 3);
                
                // Fallback: if everyone has streaks (unlikely but possible), reset pool to everyone
                if(candidates.length < App.state.config.spies) {
                     candidates = [...App.state.players];
                }

                // 3. Shuffle candidates
                for (let i = candidates.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [candidates[i], candidates[j]] = [candidates[j], candidates[i]];
                }

                // 4. Select Spies
                const spiesToPick = App.state.config.spies;
                const chosenSpyIds = candidates.slice(0, spiesToPick).map(p => p.id);

                // 5. Update State for all players
                App.state.players.forEach(p => {
                    p.hero = hero;
                    if(chosenSpyIds.includes(p.id)) {
                        p.isSpy = true;
                        p.spyStreak += 1; // Increase streak
                    } else {
                        p.isSpy = false;
                        p.spyStreak = 0;  // Reset streak for citizens
                    }
                });

                App.state.phase = 'game';
                App.state.chat = []; // clear chat
                Net.broadcast();
            },

            endRound: function() {
                App.state.phase = 'lobby';
                App.state.players.forEach(p => p.ready = false);
                Net.broadcast();
            },

            copyInvite: function() {
                const url = window.location.origin + window.location.pathname + '?code=' + App.state.roomCode;
                navigator.clipboard.writeText(url).then(() => alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!"));
            },

            // --- VIEW ---
            render: function() {
                // Screen switching
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                
                if(App.state.phase === 'menu') {
                    document.getElementById('screen-menu').classList.add('active');
                    // Check URL for code
                    const params = new URLSearchParams(location.search);
                    if(params.has('code')) document.getElementById('code-inp').value = params.get('code');
                } 
                else if(App.state.phase === 'lobby') {
                    document.getElementById('screen-lobby').classList.add('active');
                    document.getElementById('lobby-code-display').innerText = App.state.roomCode;
                    
                    // Host/Client elements
                    const isHost = App.me.isHost;
                    document.getElementById('btn-start').style.display = isHost ? 'flex' : 'none';
                    document.getElementById('host-settings-panel').style.display = isHost ? 'block' : 'none';
                    
                    const btnReady = document.getElementById('btn-ready');
                    if(isHost) {
                         btnReady.style.display = 'none';
                    } else {
                        btnReady.style.display = 'flex';
                        const me = App.state.players.find(p => p.id === App.me.id);
                        if(me) {
                            btnReady.innerText = me.ready ? "–Ø –ù–ï –ì–û–¢–û–í" : "–Ø –ì–û–¢–û–í";
                            btnReady.style.background = me.ready ? 'transparent' : '';
                            btnReady.style.border = me.ready ? '1px solid #777' : '';
                        }
                    }

                    // Render List
                    const list = document.getElementById('player-list-container');
                    list.innerHTML = '';
                    App.state.players.forEach(p => {
                        list.innerHTML += `
                            <div class="player-row ${p.ready ? 'ready' : ''}">
                                <span>${p.name} ${p.id === App.me.id ? '(–í—ã)' : ''}</span>
                                <span class="status-pill ${p.ready ? 'st-ready' : 'st-wait'}">
                                    ${p.ready ? 'READY' : 'WAIT'}
                                </span>
                            </div>
                        `;
                    });

                    this.renderChat('lobby');
                }
                else if(App.state.phase === 'game') {
                    document.getElementById('screen-game').classList.add('active');
                    this.prepareRoleCard();
                    document.getElementById('host-end-btn').style.display = App.me.isHost ? 'flex' : 'none';
                    this.renderChat('game');
                }
            },

            renderChat: function(ctx) {
                const box = document.getElementById(`chat-${ctx}`);
                box.innerHTML = '';
                App.state.chat.forEach(msg => {
                    box.innerHTML += `<div class="msg"><b>${msg.name}:</b>${msg.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            },

            prepareRoleCard: function() {
                const me = App.state.players.find(p => p.id === App.me.id);
                if(!me) return;

                const card = document.getElementById('role-overlay');
                const icon = document.getElementById('role-icon');
                const hero = document.getElementById('role-text');
                const sub = document.getElementById('role-sub');

                if(me.isSpy) {
                    card.classList.add('spy-mode');
                    icon.innerText = "üòà";
                    hero.innerText = "–¢–´ –®–ü–ò–û–ù";
                    sub.innerText = "–°–∫—Ä–æ–π—Å—è –∏ —É–≥–∞–¥–∞–π –≥–µ—Ä–æ—è";
                } else {
                    card.classList.remove('spy-mode');
                    icon.innerText = "üõ°Ô∏è";
                    hero.innerText = me.hero; // –¢—É—Ç —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è –∏–∑ –º–∞—Å—Å–∏–≤–∞ DOTA_HEROES
                    sub.innerText = "–¢—ã –ú–∏—Ä–Ω—ã–π";
                }
            },

            // --- REVEAL MECHANIC (HOLD TO SEE) ---
            reveal: function(show) {
                const overlay = document.getElementById('role-overlay');
                const btn = document.getElementById('reveal-btn');
                
                if(show) {
                    overlay.style.display = 'block';
                    btn.style.opacity = 0.2;
                } else {
                    overlay.style.display = 'none';
                    btn.style.opacity = 1;
                }
            }
        };

        // --- EXTRAS ---
        function triggerEasterEgg() {
            const el = document.getElementById('secret-modal');
            el.style.opacity = 1;
            el.style.zIndex = 9999;
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            setTimeout(() => { el.style.opacity = 0; el.style.zIndex = -1; }, 2500);
        }

        // --- STARTUP ---
        window.onload = function() {
            // Check link
            const url = new URL(window.location.href);
            if(url.searchParams.has('code')) {
                document.getElementById('code-inp').value = url.searchParams.get('code');
            }
        }

    </script>
</body>
</html>
