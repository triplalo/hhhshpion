<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPY: NEON EDITION</title>
    
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º —à—Ä–∏—Ñ—Ç—ã -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    
    <!-- PeerJS –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <!-- –°–∞–ª—é—Ç –¥–ª—è –ø–∞—Å—Ö–∞–ª–∫–∏ -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        /* --- CORE VISUALS --- */
        :root {
            --bg-dark: #050510;
            --primary: #00f2ea;   /* Neon Cyan */
            --secondary: #ff0050; /* Neon Red */
            --accent: #7df9ff;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #ffffff;
            --text-dim: #a0a0b0;
            --font-head: 'Orbitron', sans-serif;
            --font-body: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 242, 234, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(255, 0, 80, 0.05) 0%, transparent 20%);
            color: var(--text-main);
            font-family: var(--font-body);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- ANIMATIONS --- */
        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 10px var(--primary); }
            50% { box-shadow: 0 0 25px var(--primary); }
            100% { box-shadow: 0 0 10px var(--primary); }
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- UI ELEMENTS --- */
        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            animation: slide-up 0.4s ease-out;
            position: relative;
            z-index: 2;
        }
        .screen.active { display: flex; }

        .logo {
            text-align: center;
            font-family: var(--font-head);
            font-size: 3rem;
            font-weight: 900;
            background: linear-gradient(to right, var(--primary), #ffffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(0, 242, 234, 0.3);
            margin-bottom: 20px;
            letter-spacing: 2px;
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* --- INPUTS & BUTTONS --- */
        input, select {
            width: 100%;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--primary);
            color: white;
            font-family: var(--font-head);
            font-size: 1.1rem;
            text-align: center;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: 0.3s;
        }
        input:focus { box-shadow: 0 0 15px rgba(0,242,234,0.3); }

        .btn {
            width: 100%;
            padding: 18px;
            border: none;
            border-radius: 8px;
            font-family: var(--font-head);
            font-weight: 700;
            font-size: 1.1rem;
            text-transform: uppercase;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: 0.2s;
            margin-bottom: 12px;
            letter-spacing: 1px;
        }
        
        .btn-primary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            box-shadow: 0 0 10px rgba(0,242,234,0.1);
        }
        .btn-primary:active { background: var(--primary); color: #000; }

        .btn-action {
            background: var(--secondary);
            color: white;
            box-shadow: 0 0 20px rgba(255,0,80,0.4);
        }
        .btn-action:active { transform: scale(0.98); }

        .btn-ready { background: #2ecc71; color: white; }
        .btn-not-ready { background: #e74c3c; color: white; }

        /* --- LOBBY STYLES --- */
        .room-code-display {
            font-family: var(--font-head);
            font-size: 3.5rem;
            color: var(--primary);
            text-align: center;
            margin: 10px 0;
            text-shadow: 0 0 15px var(--primary);
            letter-spacing: 5px;
        }

        .player-list {
            flex-grow: 1;
            overflow-y: auto;
            margin: 15px 0;
            border-top: 1px solid var(--glass-border);
            border-bottom: 1px solid var(--glass-border);
            padding: 10px 0;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            margin-bottom: 8px;
            border-radius: 6px;
            border-left: 3px solid transparent;
        }
        .player-item.is-me { border-left-color: var(--primary); background: rgba(0,242,234,0.05); }
        .player-item .name { font-size: 1.2rem; font-weight: bold; }
        .status-badge {
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 4px;
            background: #333;
            color: #aaa;
        }
        .status-badge.ready { background: #2ecc71; color: #000; font-weight: bold; }

        /* --- CHAT --- */
        .chat-box {
            height: 200px;
            display: flex;
            flex-direction: column;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            margin-top: auto;
            border: 1px solid var(--glass-border);
        }
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.9rem;
        }
        .chat-msg { margin-bottom: 6px; }
        .chat-msg .author { color: var(--primary); font-weight: bold; margin-right: 5px; }
        .chat-msg .text { color: var(--text-dim); }
        .chat-controls {
            display: flex;
            padding: 5px;
            border-top: 1px solid var(--glass-border);
        }
        .chat-input {
            flex-grow: 1;
            background: transparent;
            border: none;
            color: white;
            padding: 10px;
            text-align: left;
            font-family: var(--font-body);
        }
        .chat-send {
            background: var(--primary);
            border: none;
            width: 40px;
            color: black;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
        }

        /* --- GAME SCREEN --- */
        .role-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .role-btn {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: #111;
            border: 4px solid var(--text-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            color: var(--text-dim);
            cursor: pointer;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            transition: 0.3s;
            position: relative;
            z-index: 10;
        }
        
        .role-card-revealed {
            display: none;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            background: #1a1a2e;
            border: 2px solid var(--primary);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 0 50px rgba(0,242,234,0.3);
            z-index: 20;
        }
        .role-card-revealed.is-spy {
            border-color: var(--secondary);
            box-shadow: 0 0 50px rgba(255,0,80,0.3);
        }

        .role-title {
            font-family: var(--font-head);
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--primary);
        }
        .is-spy .role-title { color: var(--secondary); }
        
        .role-desc { font-size: 1.1rem; color: #ccc; }

        /* --- VOTING --- */
        .voting-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,5,16,0.95);
            z-index: 100;
            display: none;
            flex-direction: column;
            padding: 30px;
            animation: slide-up 0.3s;
        }
        .vote-header { text-align: center; margin-bottom: 30px; color: var(--secondary); font-size: 2rem; font-family: var(--font-head); }
        .vote-btn {
            padding: 15px; background: #222; border: 1px solid #444; color: white;
            margin-bottom: 10px; border-radius: 8px; text-align: left;
            font-size: 1.2rem; cursor: pointer; display: flex; justify-content: space-between;
        }
        .vote-btn:hover { border-color: var(--secondary); background: #2a111a; }

        /* --- UTILS --- */
        .notification {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; padding: 10px 20px; border-radius: 20px;
            border: 1px solid var(--text-dim); z-index: 999;
            display: none; font-size: 0.9rem;
        }
        .secret-area { position: fixed; bottom: 0; right: 0; width: 50px; height: 50px; z-index: 1000; }
        .secret-msg {
            position: fixed; bottom: 60px; right: 20px; 
            font-family: 'Dancing Script', cursive; 
            color: #ff69b4; font-size: 1.2rem; 
            opacity: 0; transition: 1s;
        }

    </style>
</head>
<body>

    <div id="notify" class="notification">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <!-- 1. LOADING SCREEN -->
    <div id="screen-loading" class="screen active" style="justify-content:center; align-items:center;">
        <div class="logo">SPY<br>NEON</div>
        <p style="color: var(--text-dim)">Initializing Neural Link...</p>
    </div>

    <!-- 2. MENU SCREEN -->
    <div id="screen-menu" class="screen">
        <div class="logo">SPY</div>
        <div class="card">
            <label style="color:var(--primary); font-size:0.9rem; margin-bottom:5px; display:block;">–ò–î–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø</label>
            <input type="text" id="inp-nickname" placeholder="–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º">
            
            <div style="margin: 20px 0; border-bottom: 1px solid var(--glass-border);"></div>

            <button class="btn btn-primary" onclick="Game.createLobby()">–°–û–ó–î–ê–¢–¨ –°–ï–¢–¨</button>
            
            <div style="text-align:center; margin: 15px 0; color: var(--text-dim); font-size:0.8rem;">‚Äî –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö –£–ó–õ–£ ‚Äî</div>
            
            <input type="text" id="inp-code" placeholder="–ö–û–î –ö–û–ú–ù–ê–¢–´" style="letter-spacing: 5px; text-transform:uppercase;">
            <button class="btn btn-action" onclick="Game.joinLobby()">–í–û–ô–¢–ò</button>
        </div>
        <div style="text-align: center; margin-top: auto; font-size: 0.7rem; color: #444;">v5.0 Stable Protocol</div>
    </div>

    <!-- 3. LOBBY SCREEN -->
    <div id="screen-lobby" class="screen">
        <div class="card" style="text-align: center; padding: 15px;">
            <div style="color: var(--text-dim); font-size: 0.8rem;">–ö–û–î –î–û–°–¢–£–ü–ê</div>
            <div class="room-code-display" id="lobby-code-disp">----</div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è —Ö–æ—Å—Ç–∞) -->
        <div id="host-settings" class="card" style="display:none;">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label style="font-size:0.7rem; color:var(--text-dim);">–®–ü–ò–û–ù–´</label>
                    <select id="sel-spies" onchange="Game.updateSettings()" style="margin:0; padding:10px;">
                        <option value="1">1 –®–ø–∏–æ–Ω</option>
                        <option value="2">2 –®–ø–∏–æ–Ω–∞</option>
                        <option value="3">3 –®–ø–∏–æ–Ω–∞</option>
                    </select>
                </div>
                <div style="flex:1;">
                    <label style="font-size:0.7rem; color:var(--text-dim);">–ë–ê–ó–ê –î–ê–ù–ù–´–•</label>
                    <select id="sel-pack" onchange="Game.updateSettings()" style="margin:0; padding:10px;">
                        <option value="mix">MIX (All)</option>
                        <option value="dota">DOTA 2</option>
                        <option value="clash">CLASH</option>
                        <option value="brawl">BRAWL</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="player-list" id="lobby-list"></div>

        <button id="btn-ready" class="btn btn-ready" onclick="Game.toggleReady()">–ì–û–¢–û–í</button>
        <button id="btn-start" class="btn btn-primary" onclick="Game.hostStart()" style="display:none; border-color:var(--secondary); color:var(--secondary);">–ó–ê–ü–£–°–ö –°–ò–°–¢–ï–ú–´</button>

        <div class="chat-box">
            <div class="chat-history" id="lobby-chat"></div>
            <div class="chat-controls">
                <input type="text" class="chat-input" id="lobby-chat-inp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="chat-send" onclick="Game.sendChat('lobby')">></button>
            </div>
        </div>
    </div>

    <!-- 4. GAME SCREEN -->
    <div id="screen-game" class="screen">
        <div class="logo" style="font-size: 2rem;">–ò–ì–†–ê</div>

        <div class="role-container">
            <div class="role-btn" 
                 onmousedown="Game.reveal(true)" 
                 onmouseup="Game.reveal(false)"
                 ontouchstart="Game.reveal(true)" 
                 ontouchend="Game.reveal(false)">
                ?
            </div>
            
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–æ–ª–∏ (–°–∫—Ä—ã—Ç–∞) -->
            <div id="role-card" class="role-card-revealed">
                <div id="role-icon" style="font-size: 3rem; margin-bottom: 10px;"></div>
                <div id="role-name" class="role-title">...</div>
                <div id="role-desc" class="role-desc">...</div>
            </div>

            <p style="margin-top: 20px; color: var(--text-dim); text-align: center;">–£–¥–µ—Ä–∂–∏–≤–∞–π –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å.<br>–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π –¥—Ä—É–≥–∏–º!</p>
        </div>

        <div class="card">
            <button class="btn btn-action" onclick="Game.callVote()">–í–´–ó–í–ê–¢–¨ –ì–û–õ–û–°–û–í–ê–ù–ò–ï</button>
            <div style="text-align: center; font-size: 0.8rem; color: var(--text-dim);">
                –ì–æ–ª–æ—Å–æ–≤: <span id="vote-count" style="color:white; font-weight:bold;">0</span> / <span id="vote-total">0</span>
            </div>
        </div>

        <div class="chat-box" style="height: 150px;">
            <div class="chat-history" id="game-chat"></div>
            <div class="chat-controls">
                <input type="text" class="chat-input" id="game-chat-inp" placeholder="–û–±—Å—É–∂–¥–µ–Ω–∏–µ...">
                <button class="chat-send" onclick="Game.sendChat('game')">></button>
            </div>
        </div>
    </div>

    <!-- 5. VOTING SCREEN -->
    <div id="screen-voting" class="voting-overlay">
        <div class="vote-header">–ö–¢–û –ü–†–ï–î–ê–¢–ï–õ–¨?</div>
        <div id="vote-list" style="flex-grow:1; overflow-y:auto;"></div>
        <button class="btn btn-primary" onclick="Game.closeVote()" style="margin-top:20px;">–û–¢–ú–ï–ù–ê / –í–ï–†–ù–£–¢–¨–°–Ø</button>
        <button id="btn-end-game" class="btn btn-action" onclick="Game.endGame()" style="display:none;">–ó–ê–í–ï–†–®–ò–¢–¨ –ò–ì–†–£</button>
    </div>

    <!-- –ü–ê–°–•–ê–õ–ö–ê -->
    <div class="secret-area" onclick="activateSecret()"></div>
    <div id="secret-msg" class="secret-msg">–Ø –ª—é–±–ª—é –°–æ–Ω—é ‚ù§Ô∏è</div>

    <script>
        /* 
           ================================================================
           DATA CORE: CHARACTERS (NO IMAGES, TEXT ONLY)
           ================================================================
        */
        const DB = {
            dota: [
                "Pudge", "Invoker", "Juggernaut", "CM", "Techies", "Sniper", "Axe", "SF", "Anti-Mage", 
                "Lion", "Mirana", "Windranger", "Earthshaker", "Sven", "Zeus", "Void", "PA", "Riki", 
                "Drow Ranger", "Lina", "Tidehunter", "Enigma", "Roshan", "Meepo", "Rubick", "Tiny", "Kunkka"
            ],
            clash: [
                "P.E.K.K.A", "Hog Rider", "Mega Knight", "Golem", "Giant", "Miner", "Princess", "Wizard",
                "Valkyrie", "Musketeer", "Baby Dragon", "Prince", "Skeleton Army", "Goblin Barrel", "Balloon",
                "X-Bow", "Inferno Tower", "Sparky", "Lava Hound", "Electro Wizard", "Ice Wizard", "Bandit"
            ],
            brawl: [
                "Shelly", "Colt", "El Primo", "Poco", "Rosa", "Rico", "Darryl", "Penny", "Piper", "Pam", 
                "Frank", "Mortis", "Tara", "Gene", "Spike", "Crow", "Leon", "Sandy", "Amber", "Meg"
            ]
        };

        /* 
           ================================================================
           GAME ENGINE
           ================================================================
        */
        const Game = {
            peer: null,
            conn: null,
            myId: null,
            myName: '',
            isHost: false,
            roomCode: '',
            hostConnections: [], // –¢–æ–ª—å–∫–æ –¥–ª—è —Ö–æ—Å—Ç–∞
            
            // STATE (–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è)
            state: {
                phase: 'menu', // menu, lobby, game, voting
                players: [],   // { id, name, ready, role, isSpy, voteCall }
                chat: [],
                settings: { spies: 1, pack: 'mix' },
                voteTrigger: 0
            },

            // --- INIT ---
            init: function() {
                document.getElementById('screen-loading').classList.remove('active');
                this.showScreen('screen-menu');
            },

            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
                
                // –°–∫—Ä–æ–ª–ª –≤–Ω–∏–∑ —á–∞—Ç–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —ç–∫—Ä–∞–Ω–∞
                if(id === 'screen-lobby') this.renderChat('lobby');
                if(id === 'screen-game') this.renderChat('game');
            },

            notify: function(msg) {
                const n = document.getElementById('notify');
                n.innerText = msg;
                n.style.display = 'block';
                setTimeout(() => n.style.display = 'none', 3000);
            },

            // --- PEERJS SETUP ---
            setupPeer: function(hostMode, inputCode = null) {
                // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è ID —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
                const timestamp = Date.now().toString().slice(-5);
                
                if (hostMode) {
                    this.roomCode = this.generateCode();
                    this.myId = `spy-host-${this.roomCode}-${timestamp}`;
                    this.isHost = true;
                } else {
                    this.roomCode = inputCode;
                    this.myId = `spy-client-${timestamp}-${Math.random().toString(36).substr(2,4)}`;
                    this.isHost = false;
                }

                this.myName = document.getElementById('inp-nickname').value.trim() || (this.isHost ? "ADMIN" : "USER");

                // –°–æ–∑–¥–∞–Ω–∏–µ Peer
                this.peer = new Peer(this.myId);

                this.peer.on('open', (id) => {
                    console.log('My ID:', id);
                    if (this.isHost) {
                        this.onHostReady();
                    } else {
                        this.connectToHost();
                    }
                });

                this.peer.on('error', (err) => {
                    console.error(err);
                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.type);
                    location.reload();
                });

                // –ï—Å–ª–∏ –º—ã —Ö–æ—Å—Ç - —Å–ª—É—à–∞–µ–º –≤—Ö–æ–¥—è—â–∏–µ
                if (this.isHost) {
                    this.peer.on('connection', (conn) => {
                        this.hostConnections.push(conn);
                        
                        conn.on('data', (data) => this.handleDataHost(data, conn));
                        conn.on('close', () => {
                            this.hostConnections = this.hostConnections.filter(c => c !== conn);
                            this.removePlayer(conn.peer);
                        });
                        
                        // –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —Å—Ä–∞–∑—É –∫–∏–¥–∞–µ–º —Å—Ç–µ–π—Ç
                        conn.on('open', () => {
                             conn.send({ type: 'SYNC', state: this.state });
                        });
                    });
                }
            },

            // --- HOST LOGIC ---
            onHostReady: function() {
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–µ–π—Ç–∞
                this.state.phase = 'lobby';
                this.state.players = [{ 
                    id: this.myId, 
                    name: this.myName, 
                    ready: true, // –•–æ—Å—Ç –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤
                    voteCall: false 
                }];
                
                this.showScreen('screen-lobby');
                this.renderLobby();
            },

            handleDataHost: function(data, conn) {
                let needBroadcast = false;

                if (data.type === 'JOIN') {
                    // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
                    // conn.peer - —ç—Ç–æ ID –ø–∏—Ä–∞
                    const existing = this.state.players.find(p => p.id === data.id);
                    if (!existing) {
                        this.state.players.push({
                            id: data.id,
                            name: data.name,
                            ready: false,
                            voteCall: false
                        });
                        needBroadcast = true;
                        this.notify(`${data.name} –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è`);
                    }
                }
                else if (data.type === 'ACTION') {
                    const p = this.state.players.find(p => p.id === data.id);
                    if (p) {
                        if (data.action === 'toggleReady') p.ready = !p.ready;
                        if (data.action === 'callVote') {
                            p.voteCall = !p.voteCall;
                            this.checkVoteTrigger();
                        }
                        needBroadcast = true;
                    }
                }
                else if (data.type === 'CHAT') {
                    this.addChatMsg(data.name, data.text);
                    needBroadcast = true;
                }

                if (needBroadcast) this.broadcastState();
            },

            broadcastState: function() {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ–±—è
                this.renderApp();
                
                // –†–∞—Å—Å—ã–ª–∞–µ–º –≤—Å–µ–º
                this.hostConnections.forEach(c => {
                    if (c.open) {
                        c.send({ type: 'SYNC', state: this.state });
                    }
                });
            },

            // --- CLIENT LOGIC ---
            connectToHost: function() {
                // –ü—ã—Ç–∞–µ–º—Å—è –Ω–∞–π—Ç–∏ ID —Ö–æ—Å—Ç–∞. –ù–æ ID —Ö–æ—Å—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç timestamp, –∫–æ—Ç–æ—Ä—ã–π –º—ã –Ω–µ –∑–Ω–∞–µ–º.
                // –ü–†–û–ë–õ–ï–ú–ê PEERJS: –ú—ã –Ω–µ –º–æ–∂–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è, –Ω–µ –∑–Ω–∞—è —Ç–æ—á–Ω—ã–π ID.
                // –†–ï–®–ï–ù–ò–ï: –í —ç—Ç–æ–π –≤–µ—Ä—Å–∏–∏ —è —Å–¥–µ–ª–∞–ª —Ñ–∏–Ω—Ç. –•–æ—Å—Ç –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å –ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º—ã–π ID –¥–ª—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è?
                // –ù–µ—Ç, PeerJS –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ID –±—ã—Å—Ç—Ä–æ.
                // –ü–û–≠–¢–û–ú–£: –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –º–µ—Ö–∞–Ω–∏–∑–º —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø–µ—Ä–µ–±–æ—Ä–∞ –∏–ª–∏...
                // –°–¢–û–ü. –í –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö —Ä–∞–±–æ—Ç–∞–ª–æ, –ø–æ—Ç–æ–º—É —á—Ç–æ ID –±—ã–ª —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω.
                // –ß—Ç–æ–±—ã –ª–æ–±–±–∏ —Ä–∞–±–æ—Ç–∞–ª–æ –°–¢–ê–ë–ò–õ–¨–ù–û, –≤–µ—Ä–Ω–µ–º—Å—è –∫ "–∫–æ–¥–æ–≤–æ–º—É" ID, –Ω–æ –¥–æ–±–∞–≤–∏–º –ø—Ä–µ—Ñ–∏–∫—Å –≤–µ—Ä—Å–∏–∏.
                
                // –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø:
                // –ú—ã –±—É–¥–µ–º –∏—Å–∫–∞—Ç—å —Ö–æ—Å—Ç–∞ –ø–æ ID: `spy-host-${CODE}-stable`
                // (–•–æ—Å—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Ñ–æ—Ä–º–∞—Ç).
                
                // –í–ê–ñ–ù–û: –•–æ—Å—Ç –ø–µ—Ä–µ—Å–æ–∑–¥–∞–µ—Ç Peer.
            },

            // –ü–ï–†–ï–ü–ò–°–´–í–ê–ï–ú GENERATE ID –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
            // –•–æ—Å—Ç —Å–æ–∑–¥–∞–µ—Ç ID: spy-host-ABCD-v5
            // –ö–ª–∏–µ–Ω—Ç –∫–æ–Ω–Ω–µ–∫—Ç–∏—Ç—Å—è –∫: spy-host-ABCD-v5
            
            // --- –ü–ï–†–ï–ó–ê–ü–ò–°–¨ –§–£–ù–ö–¶–ò–ô ID ---
            createLobby: function() {
                const code = this.generateCode();
                this.roomCode = code;
                this.myId = `spy-host-${code}-v5`; // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å—É—Ñ—Ñ–∏–∫—Å –≤–µ—Ä—Å–∏–∏
                this.isHost = true;
                this.myName = document.getElementById('inp-nickname').value.trim() || "ADMIN";
                
                this.startPeerSession();
            },

            joinLobby: function() {
                const code = document.getElementById('inp-code').value.trim().toUpperCase();
                if(code.length !== 4) return alert("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 —Å–∏–º–≤–æ–ª–∞");
                this.roomCode = code;
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
                this.myId = `spy-client-${Date.now()}`;
                this.isHost = false;
                this.myName = document.getElementById('inp-nickname').value.trim() || "USER";

                this.startPeerSession();
            },

            startPeerSession: function() {
                if (this.peer) this.peer.destroy();
                
                this.peer = new Peer(this.myId);

                this.peer.on('open', (id) => {
                    if(this.isHost) {
                        this.onHostReady();
                    } else {
                        // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Ö–æ—Å—Ç—É
                        const targetId = `spy-host-${this.roomCode}-v5`;
                        console.log("Connecting to:", targetId);
                        this.conn = this.peer.connect(targetId);
                        
                        this.conn.on('open', () => {
                            console.log("Connected!");
                            this.conn.send({ type: 'JOIN', id: this.myId, name: this.myName });
                        });
                        
                        this.conn.on('data', (data) => {
                            if(data.type === 'SYNC') {
                                this.state = data.state;
                                this.renderApp();
                            }
                        });

                        this.conn.on('close', () => {
                            alert("–•–æ—Å—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è.");
                            location.reload();
                        });
                        
                        // –¢–∞–π–º–∞—É—Ç
                        setTimeout(() => {
                            if(!this.conn.open) {
                                // alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è. –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥.");
                            }
                        }, 5000);
                    }
                });

                this.peer.on('error', err => {
                    console.log(err);
                    if(err.type === 'peer-unavailable') alert("–õ–æ–±–±–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ!");
                    else alert("–û—à–∏–±–∫–∞: " + err.type);
                });
                
                // Host Listener moved up
                if(this.isHost) {
                    this.peer.on('connection', (conn) => {
                        this.hostConnections.push(conn);
                        conn.on('data', (data) => this.handleDataHost(data, conn));
                        conn.on('close', () => {
                            this.hostConnections = this.hostConnections.filter(c => c !== conn);
                            this.removePlayer(conn.peer);
                        });
                        conn.on('open', () => conn.send({ type: 'SYNC', state: this.state }));
                    });
                }
            },

            // --- GAME LOGIC ---
            removePlayer: function(id) {
                this.state.players = this.state.players.filter(p => p.id !== id);
                this.broadcastState();
            },

            updateSettings: function() {
                if(!this.isHost) return;
                this.state.settings.spies = parseInt(document.getElementById('sel-spies').value);
                this.state.settings.pack = document.getElementById('sel-pack').value;
                this.broadcastState();
            },

            toggleReady: function() {
                if(this.isHost) return; // –•–æ—Å—Ç –≤—Å–µ–≥–¥–∞ –≥–æ—Ç–æ–≤
                this.conn.send({ type: 'ACTION', id: this.myId, action: 'toggleReady' });
            },

            sendChat: function(ctx) {
                const inp = document.getElementById(ctx + '-chat-inp');
                const text = inp.value.trim();
                if(!text) return;
                
                if(this.isHost) {
                    this.addChatMsg(this.myName, text);
                    this.broadcastState();
                } else {
                    this.conn.send({ type: 'CHAT', name: this.myName, text: text });
                }
                inp.value = "";
            },

            addChatMsg: function(name, text) {
                this.state.chat.push({ name, text });
                if(this.state.chat.length > 50) this.state.chat.shift();
            },

            hostStart: function() {
                if(this.state.players.length < 3) return alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –∏–≥—Ä–æ–∫–∞!");
                
                // –õ–æ–≥–∏–∫–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä–æ–ª–µ–π
                let indices = this.state.players.map((_, i) => i);
                // Shuffle
                for (let i = indices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [indices[i], indices[j]] = [indices[j], indices[i]];
                }

                // –í—ã–±–æ—Ä –ø–∞–∫–∞
                let pool = [];
                const pack = this.state.settings.pack;
                if(pack === 'mix') pool = [...DB.dota, ...DB.clash, ...DB.brawl];
                else pool = DB[pack];
                
                const location = pool[Math.floor(Math.random() * pool.length)];
                const spyCount = this.state.settings.spies;

                this.state.players.forEach((p, idx) => {
                    const isSpy = indices.indexOf(idx) < spyCount;
                    p.isSpy = isSpy;
                    p.location = location;
                    p.voteCall = false;
                });

                this.state.phase = 'game';
                this.state.voteTrigger = 0;
                this.state.chat = []; // –û—á–∏—Å—Ç–∫–∞ —á–∞—Ç–∞
                this.addChatMsg("–°–ò–°–¢–ï–ú–ê", `–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –®–ø–∏–æ–Ω–æ–≤: ${spyCount}`);
                
                this.broadcastState();
            },

            callVote: function() {
                if(this.isHost) {
                    const p = this.state.players.find(p => p.id === this.myId);
                    p.voteCall = !p.voteCall;
                    this.checkVoteTrigger();
                    this.broadcastState();
                } else {
                    this.conn.send({ type: 'ACTION', id: this.myId, action: 'callVote' });
                }
            },

            checkVoteTrigger: function() {
                const votes = this.state.players.filter(p => p.voteCall).length;
                this.state.voteTrigger = votes;
                if(votes > this.state.players.length / 2) {
                    this.state.phase = 'voting';
                    this.addChatMsg("–°–ò–°–¢–ï–ú–ê", "–í–Ω–∏–º–∞–Ω–∏–µ! –ù–∞—á–∞–ª–æ—Å—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ!");
                }
            },

            endGame: function() {
                this.state.phase = 'lobby';
                this.state.players.forEach(p => {
                    p.ready = (p.id === this.myId && this.isHost); 
                    p.voteCall = false;
                });
                this.broadcastState();
            },
            
            closeVote: function() {
                if(!this.isHost) return;
                // –û—Ç–º–µ–Ω–∞ –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏—è (–≤–æ–∑–≤—Ä–∞—Ç –≤ –∏–≥—Ä—É)
                this.state.phase = 'game';
                this.state.players.forEach(p => p.voteCall = false);
                this.state.voteTrigger = 0;
                this.broadcastState();
            },

            // --- RENDERING ---
            renderApp: function() {
                if(this.state.phase === 'lobby') {
                    this.showScreen('screen-lobby');
                    this.renderLobby();
                    this.renderChat('lobby');
                } 
                else if(this.state.phase === 'game') {
                    this.showScreen('screen-game');
                    this.renderGame();
                    this.renderChat('game');
                    document.getElementById('screen-voting').style.display = 'none';
                }
                else if(this.state.phase === 'voting') {
                    this.showScreen('screen-game');
                    document.getElementById('screen-voting').style.display = 'flex';
                    this.renderVoting();
                }
            },

            renderLobby: function() {
                document.getElementById('lobby-code-disp').innerText = this.roomCode;
                const list = document.getElementById('lobby-list');
                list.innerHTML = '';

                this.state.players.forEach(p => {
                    const el = document.createElement('div');
                    el.className = 'player-item' + (p.id === this.myId ? ' is-me' : '');
                    el.innerHTML = `
                        <span class="name">${p.name}</span>
                        <span class="status-badge ${p.ready ? 'ready' : ''}">${p.ready ? '–ì–û–¢–û–í' : '–ñ–î–ï–¢'}</span>
                    `;
                    list.appendChild(el);
                });

                if(this.isHost) {
                    document.getElementById('host-settings').style.display = 'block';
                    document.getElementById('btn-start').style.display = 'block';
                    document.getElementById('btn-ready').style.display = 'none';
                } else {
                    document.getElementById('host-settings').style.display = 'none';
                    document.getElementById('btn-start').style.display = 'none';
                    const btnR = document.getElementById('btn-ready');
                    btnR.style.display = 'block';
                    const me = this.state.players.find(p => p.id === this.myId);
                    if(me && me.ready) {
                        btnR.innerText = "–ù–ï –ì–û–¢–û–í";
                        btnR.className = "btn btn-not-ready";
                    } else {
                        btnR.innerText = "–ì–û–¢–û–í";
                        btnR.className = "btn btn-ready";
                    }
                }
            },

            renderChat: function(ctx) {
                const box = document.getElementById(ctx + '-chat');
                box.innerHTML = '';
                this.state.chat.forEach(msg => {
                    const d = document.createElement('div');
                    d.className = 'chat-msg';
                    d.innerHTML = `<span class="author">${msg.name}:</span><span class="text">${msg.text}</span>`;
                    box.appendChild(d);
                });
                box.scrollTop = box.scrollHeight;
            },

            renderGame: function() {
                // –ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ
                document.getElementById('vote-count').innerText = this.state.voteTrigger;
                document.getElementById('vote-total').innerText = Math.ceil(this.state.players.length/2 + 0.1);

                // –†–æ–ª—å
                const me = this.state.players.find(p => p.id === this.myId);
                const card = document.getElementById('role-card');
                const icon = document.getElementById('role-icon');
                const name = document.getElementById('role-name');
                const desc = document.getElementById('role-desc');

                if (me.isSpy) {
                    card.className = "role-card-revealed is-spy";
                    icon.innerText = "üïµÔ∏è‚Äç‚ôÇÔ∏è";
                    name.innerText = "–®–ü–ò–û–ù";
                    desc.innerText = "–¢–≤–æ—è —Ü–µ–ª—å: –Ω–µ –≤—ã–¥–∞—Ç—å —Å–µ–±—è –∏ —É–≥–∞–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞";
                } else {
                    card.className = "role-card-revealed";
                    icon.innerText = "üõ°Ô∏è";
                    name.innerText = me.location;
                    desc.innerText = "–¢—ã –º–∏—Ä–Ω—ã–π. –í—ã—á–∏—Å–ª–∏ —à–ø–∏–æ–Ω–∞!";
                }
            },

            renderVoting: function() {
                const list = document.getElementById('vote-list');
                list.innerHTML = '';
                
                this.state.players.forEach(p => {
                    const btn = document.createElement('div');
                    btn.className = 'vote-btn';
                    btn.innerText = p.name;
                    btn.onclick = () => {
                        // –í—Å–∫—Ä—ã—Ç–∏–µ (—Ç–æ–ª—å–∫–æ –≤–∏–∑—É–∞–ª)
                        if(this.isHost) {
                            alert(`${p.name} ‚Äî ${p.isSpy ? '–®–ü–ò–û–ù! –ü–û–ë–ï–î–ê –ú–ò–†–ù–´–•!' : '–ú–ò–†–ù–´–ô... –û–®–ò–ë–ö–ê.'}`);
                        } else {
                            alert("–ù–∞–∑–æ–≤–∏ —Å–≤–æ–π –≥–æ–ª–æ—Å –≤—Å–ª—É—Ö!");
                        }
                    };
                    list.appendChild(btn);
                });

                if(this.isHost) document.getElementById('btn-end-game').style.display = 'block';
                else document.getElementById('btn-end-game').style.display = 'none';
            },

            reveal: function(show) {
                const card = document.getElementById('role-card');
                card.style.display = show ? 'block' : 'none';
            },

            generateCode: function() {
                const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
                let res = "";
                for(let i=0; i<4; i++) res += chars.charAt(Math.floor(Math.random()*chars.length));
                return res;
            }
        };

        // --- EASTER EGG ---
        function activateSecret() {
            const msg = document.getElementById('secret-msg');
            msg.style.opacity = '1';
            
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });

            setTimeout(() => msg.style.opacity = '0', 3000);
        }

        // Start
        setTimeout(() => Game.init(), 1000);

    </script>
</body>
</html>
