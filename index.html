<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPY ONLINE PRO üïµÔ∏è‚Äç‚ôÇÔ∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;800&family=Fredoka+One&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

    <style>
        :root {
            --primary: #ff4757;
            --secondary: #2ed573;
            --blue: #3742fa;
            --dark: #1e272e;
            --panel: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: 'Nunito', sans-serif;
            background: var(--dark);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }

        /* --- UI COMPONENTS --- */
        .screen { display: none; height: 100vh; flex-direction: column; padding: 15px; }
        .screen.active { display: flex; }

        .header { text-align: center; margin-bottom: 10px; }
        h1 { font-family: 'Fredoka One'; margin: 0; color: var(--primary); letter-spacing: 1px; }

        .card {
            background: var(--panel);
            border-radius: 20px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn {
            width: 100%; padding: 15px; border-radius: 12px; border: none;
            font-size: 1.1rem; font-weight: 800; cursor: pointer;
            transition: transform 0.1s; color: white; margin-bottom: 10px;
            font-family: 'Nunito', sans-serif;
        }
        .btn:active { transform: scale(0.96); }
        .btn-green { background: var(--secondary); box-shadow: 0 4px 0 #218c53; }
        .btn-red { background: var(--primary); box-shadow: 0 4px 0 #c0392b; }
        .btn-blue { background: var(--blue); box-shadow: 0 4px 0 #272ebf; }

        input, select {
            width: 100%; padding: 12px; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2);
            background: rgba(0,0,0,0.3); color: white; margin-bottom: 10px; font-size: 1rem;
        }

        /* --- LOBBY LIST --- */
        .player-list {
            flex-grow: 1; overflow-y: auto; margin-bottom: 10px;
            background: rgba(0,0,0,0.2); border-radius: 15px; padding: 10px;
        }
        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: rgba(255,255,255,0.05); border-radius: 10px; margin-bottom: 5px;
        }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; background: #555; }
        .status-dot.ready { background: var(--secondary); box-shadow: 0 0 10px var(--secondary); }

        /* --- CHAT --- */
        .chat-container {
            height: 200px; display: flex; flex-direction: column;
            background: rgba(0,0,0,0.3); border-radius: 15px; padding: 10px; margin-top: auto;
        }
        .chat-messages {
            flex-grow: 1; overflow-y: auto; margin-bottom: 10px; font-size: 0.9rem;
        }
        .chat-msg { margin-bottom: 5px; word-wrap: break-word; }
        .chat-msg b { color: var(--secondary); }
        .chat-input-row { display: flex; gap: 5px; }

        /* --- GAME ROLE --- */
        .role-hidden {
            width: 180px; height: 180px; background: #333; border-radius: 20px;
            margin: 20px auto; display: flex; align-items: center; justify-content: center;
            font-size: 4rem; cursor: pointer; border: 4px dashed #555;
        }
        .role-img { width: 100%; height: 100%; object-fit: cover; border-radius: 16px; }
        .spy-alert { 
            width: 100%; height: 100%; background: var(--primary); border-radius: 16px;
            display: flex; align-items: center; justify-content: center; text-align: center;
            font-weight: 900; font-size: 2rem; padding: 10px; animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- VOTING --- */
        .vote-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 100; padding: 20px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .vote-btn {
            background: #333; color: white; padding: 15px; margin-bottom: 10px;
            border-radius: 10px; border: 1px solid #555; cursor: pointer; text-align: left;
        }
        .vote-btn.voted { background: var(--primary); border-color: var(--primary); }

        .info-tag { font-size: 0.8rem; color: #aaa; text-align: center; margin-top: 5px; }
    </style>
</head>
<body>

    <!-- 1. MENU -->
    <div id="screen-menu" class="screen active">
        <div class="header"><h1>üïµÔ∏è‚Äç‚ôÇÔ∏è SPY PRO</h1></div>
        <div class="card">
            <label>–¢–≤–æ–π –Ω–∏–∫–Ω–µ–π–º:</label>
            <input type="text" id="my-name" placeholder="–í–≤–µ–¥–∏ –∏–º—è...">
            
            <div style="height: 20px;"></div>

            <button class="btn btn-blue" onclick="createGame()">–°–û–ó–î–ê–¢–¨ –õ–û–ë–ë–ò</button>
            <p style="text-align:center; margin: 10px 0; opacity: 0.5;">- –ò–õ–ò -</p>
            <input type="text" id="join-code" placeholder="–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã (4 —Å–∏–º–≤–æ–ª–∞)" style="text-align:center; text-transform:uppercase; letter-spacing: 3px; font-weight:bold;">
            <button class="btn btn-green" onclick="joinGame()">–ü–†–ò–°–û–ï–î–ò–ù–ò–¢–¨–°–Ø</button>
        </div>
    </div>

    <!-- 2. LOBBY -->
    <div id="screen-lobby" class="screen">
        <div class="header">
            <h1 style="font-size:1.5rem;">–ö–û–î: <span id="lobby-code" style="color:white; border-bottom: 2px dashed #fff;">????</span></h1>
        </div>
        
        <!-- Host Controls -->
        <div id="host-controls" class="card" style="display:none;">
            <label>–®–ø–∏–æ–Ω–æ–≤:</label>
            <select id="spy-count-select" onchange="updateSettings()">
                <option value="1">1 –®–ø–∏–æ–Ω</option>
                <option value="2">2 –®–ø–∏–æ–Ω–∞</option>
                <option value="3">3 –®–ø–∏–æ–Ω–∞</option>
            </select>
            <label>–ù–∞–±–æ—Ä:</label>
            <select id="pack-select" onchange="updateSettings()">
                <option value="mix">Dota + Clash (Mix)</option>
                <option value="dota">–¢–æ–ª—å–∫–æ Dota 2</option>
                <option value="clash">–¢–æ–ª—å–∫–æ Clash Royale</option>
            </select>
        </div>

        <div class="player-list" id="lobby-player-list">
            <!-- JS renders players here -->
        </div>

        <button class="btn btn-green" id="btn-ready" onclick="toggleReady()">–Ø –ì–û–¢–û–í ‚úÖ</button>
        <button class="btn btn-red" id="btn-start" onclick="hostStartGame()" style="display:none;">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£ üöÄ</button>

        <!-- Chat -->
        <div class="chat-container">
            <div class="chat-messages" id="lobby-chat"></div>
            <div class="chat-input-row">
                <input type="text" id="lobby-chat-input" placeholder="–ß–∞—Ç..." style="margin:0;">
                <button class="btn btn-blue" onclick="sendChat('lobby')" style="width: 60px; margin:0;">‚û§</button>
            </div>
        </div>
    </div>

    <!-- 3. GAME -->
    <div id="screen-game" class="screen">
        <div class="header"><h1>–í –ò–ì–†–ï</h1></div>
        
        <div class="card" style="text-align:center;">
            <p style="margin:0; opacity:0.7;">–£–¥–µ—Ä–∂–∏–≤–∞–π, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–æ–ª—å:</p>
            <div id="role-area" class="role-hidden"
                 onmousedown="reveal(true)" onmouseup="reveal(false)"
                 ontouchstart="reveal(true)" ontouchend="reveal(false)">
                ?
            </div>
            <div id="role-secret" style="display:none;"></div>
            <p class="info-tag">–ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–æ—Å–µ–¥—è–º!</p>
        </div>

        <div class="card">
            <button class="btn btn-red" onclick="callVote()">üö® –í–´–ó–í–ê–¢–¨ –ì–û–õ–û–°–û–í–ê–ù–ò–ï (<span id="vote-progress">0</span>)</button>
            <p class="info-tag">–ï—Å–ª–∏ >50% –Ω–∞–∂–º—É—Ç, –Ω–∞—á–Ω–µ–º –≤—ã–±–∏—Ä–∞—Ç—å —à–ø–∏–æ–Ω–∞</p>
        </div>

        <!-- Chat -->
        <div class="chat-container">
            <div class="chat-messages" id="game-chat"></div>
            <div class="chat-input-row">
                <input type="text" id="game-chat-input" placeholder="–û–±—Å—É–∂–¥–µ–Ω–∏–µ..." style="margin:0;">
                <button class="btn btn-blue" onclick="sendChat('game')" style="width: 60px; margin:0;">‚û§</button>
            </div>
        </div>
    </div>

    <!-- 4. VOTING MODAL -->
    <div id="screen-voting" class="vote-overlay" style="display:none;">
        <h2 style="text-align:center; color: white;">–ö–¢–û –®–ü–ò–û–ù?</h2>
        <div id="voting-list"></div>
        <button class="btn btn-red" onclick="closeVoting()" style="margin-top:20px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É (–•–æ—Å—Ç)</button>
    </div>

    <!-- SOUNDS -->
    <audio id="snd-msg" src="https://assets.mixkit.co/active_storage/sfx/2346/2346-preview.mp3"></audio>
    <audio id="snd-start" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>

    <script>
        // ================= DATA =================
        const PACKS = {
            dota: [
                "Pudge", "Invoker", "Juggernaut", "Crystal Maiden", "Techies", "Sniper", "Axe", "Shadow Fiend", 
                "Anti-Mage", "Lion", "Witch Doctor", "Mirana", "Windranger", "Earthshaker", "Sven", "Zeus",
                "Faceless Void", "Phantom Assassin", "Riki", "Drow Ranger", "Lina", "Tidehunter", "Enigma",
                "Roshan", "Shopkeeper", "Meepo", "Rubick", "Tiny", "Kunkka", "Slark"
            ],
            clash: [
                "P.E.K.K.A", "Hog Rider", "Mega Knight", "Golem", "Giant", "Miner", "Princess", "Wizard",
                "Valkyrie", "Musketeer", "Baby Dragon", "Prince", "Skeleton Army", "Goblin Barrel", "Balloon",
                "X-Bow", "Inferno Tower", "Sparky", "Lava Hound", "Electro Wizard", "Ice Wizard", "Bandit",
                "Royal Giant", "Elite Barbarians", "Knight", "Archers", "Minions", "Clash King"
            ]
        };

        // ================= STATE =================
        const APP_ID = "spy-pro-v2-";
        let peer, conn;
        let myId, hostId;
        let isHost = false;
        let myName = "";
        
        let state = {
            phase: 'lobby', 
            players: [], 
            chat: [],
            settings: { spies: 1, pack: 'mix' },
            voteTrigger: 0
        };

        // ================= INIT =================
        function createGame() {
            initPeer(true);
        }

        function joinGame() {
            const code = document.getElementById('join-code').value.toUpperCase();
            if(code.length !== 4) return alert("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 —Å–∏–º–≤–æ–ª–∞!");
            initPeer(false, code);
        }

        function initPeer(hostMode, code = null) {
            myName = document.getElementById('my-name').value || (hostMode ? "–•–æ—Å—Ç" : "–ò–≥—Ä–æ–∫");
            const roomCode = hostMode ? generateCode() : code;
            myId = APP_ID + roomCode + (hostMode ? "-host" : "-" + Math.random().toString(36).substr(2, 5));
            hostId = APP_ID + roomCode + "-host";

            peer = new Peer(myId);

            peer.on('open', (id) => {
                if(hostMode) {
                    isHost = true;
                    state.players.push({ id: myId, name: myName, ready: false, voteCall: false });
                    
                    // --- –í–û–¢ –¢–£–¢ –ë–´–õ–ê –û–®–ò–ë–ö–ê, –Ø –ò–°–ü–†–ê–í–ò–õ ---
                    // –†–∞–Ω—å—à–µ –±—Ä–∞–ª—Å—è –∏–Ω–¥–µ–∫—Å [2], –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª 'v2', —Ç–µ–ø–µ—Ä—å –±–µ—Ä–µ–º [3], –∫–æ—Ç–æ—Ä—ã–π –µ—Å—Ç—å –ö–û–î.
                    document.getElementById('lobby-code').innerText = roomCode;
                    
                    document.getElementById('host-controls').style.display = 'block';
                    document.getElementById('btn-start').style.display = 'block';
                    showScreen('screen-lobby');
                    renderLobby();
                } else {
                    connectToHost();
                }
            });

            if(hostMode) {
                peer.on('connection', (c) => {
                    c.on('data', (data) => handleDataHost(data, c.peer));
                    c.on('close', () => removePlayer(c.peer));
                });
            }

            peer.on('error', err => {
                console.log(err);
                if(err.type === 'peer-unavailable') {
                    alert("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥.");
                } else {
                    alert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: " + err.type);
                }
            });
        }

        function connectToHost() {
            conn = peer.connect(hostId);
            conn.on('open', () => {
                conn.send({ type: 'join', name: myName });
                showScreen('screen-lobby');
            });
            conn.on('data', (data) => handleDataClient(data));
            conn.on('close', () => { alert("–•–æ—Å—Ç –≤—ã—à–µ–ª!"); location.reload(); });
        }

        function generateCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // ================= LOGIC: HOST =================
        function handleDataHost(data, peerId) {
            if(data.type === 'join') {
                if(!state.players.find(p => p.id === peerId)) {
                    state.players.push({ id: peerId, name: data.name, ready: false, voteCall: false });
                }
                broadcastState();
            }
            if(data.type === 'ready') {
                const p = state.players.find(p => p.id === peerId);
                if(p) p.ready = data.value;
                broadcastState();
            }
            if(data.type === 'chat') {
                state.chat.push({ name: data.name, text: data.text });
                if(state.chat.length > 50) state.chat.shift();
                broadcastState();
            }
            if(data.type === 'call_vote') {
                const p = state.players.find(p => p.id === peerId);
                if(p) p.voteCall = !p.voteCall; 
                checkVoteTrigger();
                broadcastState();
            }
        }

        function updateSettings() {
            if(!isHost) return;
            state.settings.spies = parseInt(document.getElementById('spy-count-select').value);
            state.settings.pack = document.getElementById('pack-select').value;
            broadcastState();
        }

        function removePlayer(id) {
            state.players = state.players.filter(p => p.id !== id);
            broadcastState();
        }

        function broadcastState() {
            handleDataClient({ type: 'state', state: state });
            state.players.forEach(p => {
                if(p.id !== myId) {
                    const c = peer.connect(p.id);
                    c.on('open', () => c.send({ type: 'state', state: state }));
                }
            });
        }

        function hostStartGame() {
            if(state.players.length < 3) return alert("–ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 3 –∏–≥—Ä–æ–∫–∞!");
            
            // –§–∏—à–µ—Ä-–ô–µ–π—Ç—Å –¥–ª—è —á–µ—Å—Ç–Ω–æ–≥–æ —Ä–∞–Ω–¥–æ–º–∞
            let indices = state.players.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }

            let pool = [];
            if(state.settings.pack === 'mix') pool = [...PACKS.dota, ...PACKS.clash];
            else pool = PACKS[state.settings.pack];
            const loc = pool[Math.floor(Math.random() * pool.length)];

            const spyCount = state.settings.spies;
            state.players.forEach((p, index) => {
                const isSpy = indices.indexOf(index) < spyCount;
                p.isSpy = isSpy;
                p.role = isSpy ? "SPY" : "CITIZEN";
                p.location = loc;
                p.voteCall = false; 
            });

            state.phase = 'game';
            state.voteTrigger = 0;
            state.chat = []; 
            state.chat.push({ name: "–°–ò–°–¢–ï–ú–ê", text: "–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å! –®–ø–∏–æ–Ω–æ–≤: " + spyCount });
            
            document.getElementById('snd-start').play();
            broadcastState();
        }

        function checkVoteTrigger() {
            const votes = state.players.filter(p => p.voteCall).length;
            state.voteTrigger = votes;
            // > 50%
            if(votes > state.players.length / 2) {
                state.phase = 'voting';
                state.chat.push({ name: "–°–ò–°–¢–ï–ú–ê", text: "–ì–û–õ–û–°–û–í–ê–ù–ò–ï –ù–ê–ß–ê–õ–û–°–¨!" });
            }
        }

        // ================= LOGIC: CLIENT =================
        function handleDataClient(data) {
            if(data.type === 'state') {
                state = data.state;
                renderApp();
            }
        }

        function sendChat(context) {
            const inputId = context === 'lobby' ? 'lobby-chat-input' : 'game-chat-input';
            const input = document.getElementById(inputId);
            const text = input.value.trim();
            if(!text) return;

            const msg = { type: 'chat', name: myName, text: text };
            
            if(isHost) {
                handleDataHost(msg, myId);
            } else {
                conn.send(msg);
            }
            input.value = "";
        }

        function toggleReady() {
            const me = state.players.find(p => p.id === myId);
            const newVal = !me.ready;
            if(isHost) {
                me.ready = newVal;
                broadcastState();
            } else {
                conn.send({ type: 'ready', value: newVal });
            }
        }

        function callVote() {
            if(isHost) {
                handleDataHost({ type: 'call_vote' }, myId);
            } else {
                conn.send({ type: 'call_vote' });
            }
        }

        // ================= RENDER =================
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function renderApp() {
            if(state.phase === 'lobby') {
                showScreen('screen-lobby');
                renderLobby();
                renderChat('lobby');
            } else if(state.phase === 'game') {
                showScreen('screen-game');
                renderGame();
                renderChat('game');
                document.getElementById('screen-voting').style.display = 'none';
            } else if(state.phase === 'voting') {
                showScreen('screen-game'); 
                renderVoting();
            }
        }

        function renderLobby() {
            const list = document.getElementById('lobby-player-list');
            list.innerHTML = "";
            
            // --- –¢–£–¢ –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ö–û–î–ê –î–õ–Ø –ö–õ–ò–ï–ù–¢–ê ---
            // –ü–∞—Ä—Å–∏–º ID —Ö–æ—Å—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–æ
            const codeParts = hostId.split('-');
            // ID = spy-pro-v2-ABCD-host. –ò–Ω–¥–µ–∫—Å—ã: 0-1-2-3-4. –ù–∞–º –Ω—É–∂–µ–Ω 3.
            document.getElementById('lobby-code').innerText = codeParts[3];

            state.players.forEach(p => {
                const div = document.createElement('div');
                div.className = 'player-item';
                div.innerHTML = `
                    <span>${p.name} ${p.id === myId ? '(–í—ã)' : ''}</span>
                    <div class="status-dot ${p.ready ? 'ready' : ''}"></div>
                `;
                list.appendChild(div);
            });

            const me = state.players.find(p => p.id === myId);
            const btn = document.getElementById('btn-ready');
            if(me && me.ready) {
                btn.innerText = "–Ø –ù–ï –ì–û–¢–û–í ‚ùå";
                btn.className = "btn btn-red";
            } else {
                btn.innerText = "–Ø –ì–û–¢–û–í ‚úÖ";
                btn.className = "btn btn-green";
            }
        }

        function renderChat(ctx) {
            const container = document.getElementById(ctx + '-chat');
            container.innerHTML = "";
            state.chat.forEach(msg => {
                const d = document.createElement('div');
                d.className = 'chat-msg';
                d.innerHTML = `<b>${msg.name}:</b> ${msg.text}`;
                container.appendChild(d);
            });
            container.scrollTop = container.scrollHeight;
        }

        function renderGame() {
            const me = state.players.find(p => p.id === myId);
            if(!me) return;

            document.getElementById('vote-progress').innerText = `${state.voteTrigger}/${Math.ceil(state.players.length/2 + 0.1)}`;

            const secret = document.getElementById('role-secret');
            if(me.isSpy) {
                secret.innerHTML = `<div class="spy-alert">–¢–´ –®–ü–ò–û–ù!<br>ü§´</div>`;
            } else {
                const imgName = me.location.toLowerCase().replace(/[\s\.]/g, '') + ".jpg";
                secret.innerHTML = `
                    <div style="text-align:center; height:100%;">
                        <img src="${imgName}" class="role-img" onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=${me.location}&background=random&size=150'">
                        <h3 style="margin:5px 0;">${me.location}</h3>
                    </div>
                `;
            }
        }

        function reveal(show) {
            const area = document.getElementById('role-area');
            const secret = document.getElementById('role-secret');
            if(show) {
                area.style.display = 'none';
                secret.style.display = 'block';
            } else {
                area.style.display = 'flex';
                secret.style.display = 'none';
            }
        }

        function renderVoting() {
            const modal = document.getElementById('screen-voting');
            modal.style.display = 'flex';
            const list = document.getElementById('voting-list');
            list.innerHTML = "";
            
            state.players.forEach(p => {
                const btn = document.createElement('div');
                btn.className = 'vote-btn';
                btn.innerHTML = `${p.name}`;
                btn.onclick = () => {
                   if(isHost) {
                        alert(`${p.name} - ${p.isSpy ? '–®–ü–ò–û–ù! üî´' : '–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å'}`);
                   } else {
                        alert("–°–∫–∞–∂–∏ –≤—Å–ª—É—Ö —Å–≤–æ–π –≤—ã–±–æ—Ä!");
                   }
                };
                list.appendChild(btn);
            });
        }
        
        function closeVoting() {
            if(!isHost) return;
            if(confirm("–ó–∞–∫–æ–Ω—á–∏—Ç—å –∏–≥—Ä—É?")) {
                state.phase = 'lobby';
                state.players.forEach(p => { p.ready = false; p.voteCall = false; });
                broadcastState();
            } else {
                state.phase = 'game';
                state.voteTrigger = 0;
                state.players.forEach(p => p.voteCall = false);
                broadcastState();
            }
        }
    </script>
</body>
</html>
