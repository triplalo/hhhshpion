<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SPY: LINK JOIN</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --bg: #0f172a;
            --surface: #1e293b;
            --primary: #3b82f6;
            --text: #f1f5f9;
            --text-dim: #94a3b8;
            --accent: #8b5cf6;
            --danger: #ef4444;
            --success: #22c55e;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }

        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .screen {
            display: none;
            flex-direction: column;
            height: 100%;
            padding: 20px;
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }
        .screen.active { display: flex; }

        h1 { font-weight: 800; font-size: 1.8rem; text-align: center; margin-bottom: 20px; letter-spacing: -1px; }

        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.05);
        }

        input, select {
            width: 100%; padding: 14px; background: #0f172a; border: 1px solid #334155;
            color: white; border-radius: 10px; font-size: 1rem; text-align: center;
            margin-bottom: 10px; font-family: inherit; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); }

        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 10px;
            font-weight: 600; font-size: 1rem; cursor: pointer; margin-bottom: 10px;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn:active { transform: scale(0.98); opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: wait; }

        .btn-primary { background: var(--primary); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid var(--danger); }
        .btn-copy { background: var(--accent); color: white; }

        /* LOBBY */
        .room-code {
            font-size: 2.5rem; font-weight: 800; text-align: center;
            letter-spacing: 5px; color: var(--primary); margin: 10px 0;
            cursor: pointer;
        }
        
        .player-list { flex-grow: 1; overflow-y: auto; margin: 10px 0; }
        .player-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px;
        }
        .status-ready { color: var(--success); font-size: 0.8rem; font-weight: bold; }
        .status-wait { color: var(--text-dim); font-size: 0.8rem; }

        /* GAME */
        .role-area {
            flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .hold-btn {
            width: 200px; height: 200px; border-radius: 50%;
            background: var(--surface); border: 2px solid var(--text-dim);
            display: flex; align-items: center; justify-content: center; text-align: center;
            font-weight: bold; color: var(--text-dim); cursor: pointer;
            box-shadow: 0 0 20px rgba(0,0,0,0.2); transition: 0.2s;
            -webkit-user-select: none; -webkit-touch-callout: none;
        }
        .hold-btn:active { transform: scale(0.95); background: #334155; }
        
        .role-card {
            display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 260px; background: white; color: black; padding: 30px; border-radius: 20px;
            text-align: center; z-index: 10; pointer-events: none;
        }
        .role-card.spy { background: var(--danger); color: white; }
        .role-title { font-size: 1.8rem; font-weight: 900; margin-bottom: 5px; }

        /* CHAT */
        .chat-box { height: 150px; display: flex; flex-direction: column; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 10px; }
        .chat-history { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.85rem; }
        .chat-inp-row { display: flex; border-top: 1px solid rgba(255,255,255,0.1); }
        .chat-inp { flex-grow: 1; background: transparent; border: none; padding: 10px; color: white; text-align: left; }
        .chat-send { width: 50px; background: var(--surface); border: none; color: var(--primary); font-weight: bold; }

        /* EXTRAS */
        .status-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: #0f172a; padding: 5px; text-align: center; 
            font-size: 0.7rem; color: #64748b; border-top: 1px solid #334155;
        }
        .secret-trig { position: fixed; bottom: 30px; right: 0; width: 30px; height: 30px; }
    </style>
</head>
<body>

    <!-- STATUS BAR -->
    <div class="status-bar" id="status-bar">v8.0 ‚Ä¢ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ</div>

    <!-- 1. MENU -->
    <div id="screen-menu" class="screen active">
        <h1>SPY GAME</h1>
        
        <div class="card">
            <label style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 5px; display: block;">–¢–í–û–ï –ò–ú–Ø</label>
            <input type="text" id="inp-name" placeholder="–í–≤–µ–¥–∏ –Ω–∏–∫–Ω–µ–π–º">
            
            <div style="height: 15px;"></div>

            <button class="btn btn-primary" onclick="Game.createLobby()">–°–û–ó–î–ê–¢–¨ –ò–ì–†–£</button>
            
            <div style="text-align:center; margin:15px; color:var(--text-dim); font-size:0.8rem;">–∏–ª–∏</div>
            
            <input type="text" id="inp-code" placeholder="–ö–û–î –ö–û–ú–ù–ê–¢–´" style="text-transform:uppercase; letter-spacing:3px;">
            <button class="btn btn-outline" onclick="Game.joinLobby()">–í–û–ô–¢–ò –ü–û –ö–û–î–£</button>
        </div>
        
        <div class="secret-trig" onclick="activateSecret()"></div>
    </div>

    <!-- 2. LOBBY -->
    <div id="screen-lobby" class="screen">
        <div class="card" style="text-align:center;">
            <div style="font-size:0.8rem; color:var(--text-dim);">–ö–û–î –ö–û–ú–ù–ê–¢–´</div>
            <div class="room-code" id="lobby-code">----</div>
            <button class="btn btn-copy" onclick="Game.copyLink()">üîó –°–ö–û–ü–ò–†–û–í–ê–¢–¨ –°–°–´–õ–ö–£</button>
        </div>

        <div id="host-panel" style="display:none; margin-bottom:10px; display:flex; gap:5px;">
             <select id="sel-spies" style="margin:0;" onchange="Game.sendSettings()">
                 <option value="1">1 –®–ø–∏–æ–Ω</option>
                 <option value="2">2 –®–ø–∏–æ–Ω–∞</option>
             </select>
             <select id="sel-pack" style="margin:0;" onchange="Game.sendSettings()">
                 <option value="mix">–í—Å–µ –∏–≥—Ä—ã</option>
                 <option value="dota">Dota 2</option>
                 <option value="clash">Clash</option>
             </select>
        </div>

        <div class="player-list" id="lobby-list"></div>

        <button id="btn-ready" class="btn btn-outline" onclick="Game.toggleReady()">–ì–û–¢–û–í</button>
        <button id="btn-start" class="btn btn-primary" onclick="Game.hostStart()" style="display:none;">–ù–ê–ß–ê–¢–¨</button>

        <div class="chat-box">
            <div class="chat-history" id="lobby-chat"></div>
            <div class="chat-inp-row">
                <input type="text" class="chat-inp" id="lobby-inp" placeholder="–ß–∞—Ç...">
                <button class="chat-send" onclick="Game.chat('lobby')">‚û§</button>
            </div>
        </div>
    </div>

    <!-- 3. GAME -->
    <div id="screen-game" class="screen">
        <div class="role-area">
            <div class="hold-btn" id="reveal-btn"
                 onmousedown="Game.show(true)" onmouseup="Game.show(false)"
                 onmouseleave="Game.show(false)"
                 ontouchstart="Game.show(true)" ontouchend="Game.show(false)">
                –£–î–ï–†–ñ–ò–í–ê–ô<br>–ß–¢–û–ë–´ –£–í–ò–î–ï–¢–¨<br>–†–û–õ–¨
            </div>
            
            <div id="role-card" class="role-card">
                <div id="r-icon" style="font-size:3rem;"></div>
                <div id="r-name" class="role-title"></div>
                <div id="r-desc"></div>
            </div>
        </div>

        <button class="btn btn-danger" onclick="alert('–ì–æ–ª–æ—Å—É–π—Ç–µ –≤—Å–ª—É—Ö!')">üö® –ì–û–õ–û–°–û–í–ê–ù–ò–ï</button>
        <button id="btn-end" class="btn btn-outline" onclick="Game.endGame()" style="display:none;">–ó–ê–í–ï–†–®–ò–¢–¨</button>

        <div class="chat-box" style="height:120px;">
            <div class="chat-history" id="game-chat"></div>
            <div class="chat-inp-row">
                <input type="text" class="chat-inp" id="game-inp" placeholder="–û–±—Å—É–∂–¥–µ–Ω–∏–µ...">
                <button class="chat-send" onclick="Game.chat('game')">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        const DB = {
            dota: ["Pudge", "Invoker", "Juggernaut", "CM", "Techies", "Sniper", "Axe", "SF", "Anti-Mage", "Lion", "Zeus", "Riki", "Roshan"],
            clash: ["P.E.K.K.A", "Hog Rider", "Mega Knight", "Golem", "Giant", "Miner", "Princess", "Wizard", "Valkyrie", "Goblin Barrel"],
            brawl: ["Shelly", "Colt", "El Primo", "Leon", "Spike", "Crow", "Mortis"]
        };

        const Game = {
            peer: null, conn: null, myId: null, roomCode: null, isHost: false, name: '',
            hostConns: [],
            state: { phase: 'menu', players: [], chat: [], settings: { spies: 1, pack: 'mix' } },

            // --- STARTUP ---
            init: function() {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Å—ã–ª–∫—É (–µ—Å–ª–∏ –ø—Ä–∏—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é)
                const params = new URLSearchParams(window.location.search);
                const codeFromUrl = params.get('code');
                if(codeFromUrl) {
                    document.getElementById('inp-code').value = codeFromUrl;
                }
            },

            setStatus: function(msg) {
                document.getElementById('status-bar').innerText = msg;
            },

            showScreen: function(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            // --- NETWORKING ---
            createLobby: function() {
                this.name = document.getElementById('inp-name').value.trim() || "Host";
                this.roomCode = Math.random().toString(36).substr(2, 4).toUpperCase();
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ—Ñ–∏–∫—Å v8 –∏ –∫–æ–¥ –∫–æ–º–Ω–∞—Ç—ã. –ï—Å–ª–∏ ID –∑–∞–Ω—è—Ç, PeerJS –≤–µ—Ä–Ω–µ—Ç –æ—à–∏–±–∫—É.
                this.myId = `spy-v8-${this.roomCode}`;
                this.isHost = true;
                this.startPeer();
            },

            joinLobby: function() {
                this.name = document.getElementById('inp-name').value.trim() || "Player";
                this.roomCode = document.getElementById('inp-code').value.trim().toUpperCase();
                if(this.roomCode.length !== 4) return alert("–ö–æ–¥ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 4 —Å–∏–º–≤–æ–ª–∞");
                
                // –î–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
                this.myId = `spy-client-${Date.now()}`;
                this.isHost = false;
                this.startPeer();
            },

            startPeer: function() {
                this.setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...");
                
                if(this.peer) this.peer.destroy();
                this.peer = new Peer(this.myId);

                this.peer.on('open', (id) => {
                    this.setStatus(`–ü–æ–¥–∫–ª—é—á–µ–Ω–æ. ID: ${id}`);
                    if(this.isHost) {
                        this.state.players = [{ id: this.myId, name: this.name, ready: true }];
                        this.enterLobby();
                    } else {
                        this.connectHost();
                    }
                });

                this.peer.on('error', (err) => {
                    console.error(err);
                    if(err.type === 'unavailable-id') {
                        // –ï—Å–ª–∏ –º—ã —Ö–æ—Å—Ç –∏ ID –∑–∞–Ω—è—Ç -> –∑–Ω–∞—á–∏—Ç –∫–æ–º–Ω–∞—Ç–∞ —É–∂–µ –µ—Å—Ç—å –∏–ª–∏ –∑–∞–≤–∏—Å–ª–∞
                        if(this.isHost) {
                            alert("–ö–æ–¥ –∫–æ–º–Ω–∞—Ç—ã –∑–∞–Ω—è—Ç. –ü—Ä–æ–±—É–µ–º –¥—Ä—É–≥–æ–π...");
                            this.createLobby(); // –†–µ–∫—É—Ä—Å–∏—è (–ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞)
                        } else {
                            this.setStatus("–û—à–∏–±–∫–∞ ID");
                        }
                    } else if (err.type === 'peer-unavailable') {
                         alert("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞! –ü—Ä–æ–≤–µ—Ä—å –∫–æ–¥.");
                         this.setStatus("–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞");
                    } else {
                        this.setStatus("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + err.type);
                    }
                });

                if(this.isHost) {
                    this.peer.on('connection', (conn) => {
                        this.hostConns.push(conn);
                        conn.on('data', (data) => this.hostHandleData(data));
                        conn.on('close', () => {
                            this.hostConns = this.hostConns.filter(c => c !== conn);
                            this.state.players = this.state.players.filter(p => p.id !== conn.peer);
                            this.broadcast();
                        });
                        conn.on('open', () => conn.send({ type: 'SYNC', state: this.state }));
                    });
                }
            },

            connectHost: function() {
                const targetId = `spy-v8-${this.roomCode}`;
                this.setStatus(`–ü–æ–∏—Å–∫ –∫–æ–º–Ω–∞—Ç—ã ${this.roomCode}...`);
                
                this.conn = this.peer.connect(targetId);
                
                this.conn.on('open', () => {
                    this.setStatus("–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Ö–æ—Å—Ç—É!");
                    this.conn.send({ type: 'JOIN', id: this.myId, name: this.name });
                });

                this.conn.on('data', (data) => {
                    if(data.type === 'SYNC') {
                        this.state = data.state;
                        this.render();
                    }
                });

                this.conn.on('close', () => {
                    alert("–•–æ—Å—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è"); location.href = location.pathname;
                });
            },

            // --- HOST LOGIC ---
            hostHandleData: function(data) {
                let upd = false;
                if(data.type === 'JOIN') {
                    if(!this.state.players.find(p => p.id === data.id)) {
                        this.state.players.push({ id: data.id, name: data.name, ready: false });
                        upd = true;
                    }
                }
                if(data.type === 'READY') {
                    const p = this.state.players.find(p => p.id === data.id);
                    if(p) { p.ready = !p.ready; upd = true; }
                }
                if(data.type === 'CHAT') {
                    this.state.chat.push(data.msg);
                    if(this.state.chat.length > 30) this.state.chat.shift();
                    upd = true;
                }
                if(upd) this.broadcast();
            },

            broadcast: function() {
                this.render();
                this.hostConns.forEach(c => {
                    if(c.open) c.send({ type: 'SYNC', state: this.state });
                });
            },

            sendSettings: function() {
                if(!this.isHost) return;
                this.state.settings.spies = document.getElementById('sel-spies').value;
                this.state.settings.pack = document.getElementById('sel-pack').value;
                this.broadcast();
            },

            // --- ACTIONS ---
            enterLobby: function() {
                this.state.phase = 'lobby';
                this.showScreen('screen-lobby');
                this.render();
            },

            toggleReady: function() {
                if(this.isHost) return;
                this.conn.send({ type: 'READY', id: this.myId });
            },

            chat: function(ctx) {
                const inp = document.getElementById(ctx + '-inp');
                const txt = inp.value.trim();
                if(!txt) return;
                const msg = { name: this.name, text: txt };
                
                if(this.isHost) {
                    this.state.chat.push(msg);
                    this.broadcast();
                } else {
                    this.conn.send({ type: 'CHAT', msg: msg });
                }
                inp.value = '';
            },

            hostStart: function() {
                if(this.state.players.length < 3) return alert("–ù—É–∂–Ω–æ 3 –∏–≥—Ä–æ–∫–∞!");
                
                // Random
                let idxs = this.state.players.map((_, i) => i);
                for (let i = idxs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
                }

                let pool = [];
                const pack = this.state.settings.pack;
                if(pack === 'mix') pool = [...DB.dota, ...DB.clash, ...DB.brawl];
                else pool = DB[pack];
                
                const loc = pool[Math.floor(Math.random() * pool.length)];
                const spies = this.state.settings.spies;

                this.state.players.forEach((p, i) => {
                    p.isSpy = idxs.indexOf(i) < spies;
                    p.location = loc;
                });

                this.state.phase = 'game';
                this.state.chat = [];
                this.broadcast();
            },

            endGame: function() {
                this.state.phase = 'lobby';
                this.state.players.forEach(p => p.ready = false);
                this.broadcast();
            },

            copyLink: function() {
                // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É: —Ç–µ–∫—É—â–∏–π URL + ?code=–ö–û–î
                const url = window.location.protocol + "//" + window.location.host + window.location.pathname + "?code=" + this.roomCode;
                navigator.clipboard.writeText(url).then(() => {
                    alert("–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!");
                });
            },

            // --- RENDER ---
            render: function() {
                if(this.state.phase === 'lobby') {
                    this.showScreen('screen-lobby');
                    document.getElementById('lobby-code').innerText = this.roomCode;
                    
                    // Host settings visibility
                    const hostPanel = document.getElementById('host-panel');
                    const btnStart = document.getElementById('btn-start');
                    const btnReady = document.getElementById('btn-ready');

                    if(this.isHost) {
                        hostPanel.style.display = 'flex';
                        btnStart.style.display = 'block';
                        btnReady.style.display = 'none';
                    } else {
                        hostPanel.style.display = 'none';
                        btnStart.style.display = 'none';
                        btnReady.style.display = 'block';
                    }

                    // Players
                    const list = document.getElementById('lobby-list');
                    list.innerHTML = '';
                    this.state.players.forEach(p => {
                        const status = p.ready ? '<span class="status-ready">–ì–û–¢–û–í</span>' : '<span class="status-wait">–ñ–î–ï–¢</span>';
                        list.innerHTML += `<div class="player-item"><span>${p.name}</span>${status}</div>`;
                    });

                    // Self Ready State
                    const me = this.state.players.find(p => p.id === this.myId);
                    if(me && !this.isHost) {
                        btnReady.innerText = me.ready ? "–ù–ï –ì–û–¢–û–í" : "–ì–û–¢–û–í";
                        btnReady.style.background = me.ready ? "transparent" : "";
                        btnReady.style.border = me.ready ? "1px solid #94a3b8" : "";
                    }

                    this.renderChat('lobby');
                } 
                else if(this.state.phase === 'game') {
                    this.showScreen('screen-game');
                    this.renderRole();
                    this.renderChat('game');
                    document.getElementById('btn-end').style.display = this.isHost ? 'block' : 'none';
                }
            },

            renderChat: function(ctx) {
                const box = document.getElementById(ctx + '-chat');
                box.innerHTML = '';
                this.state.chat.forEach(m => {
                    box.innerHTML += `<div class="chat-msg"><b>${m.name}:</b> ${m.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            },

            renderRole: function() {
                const me = this.state.players.find(p => p.id === this.myId);
                const card = document.getElementById('role-card');
                const icon = document.getElementById('r-icon');
                const title = document.getElementById('r-name');
                const desc = document.getElementById('r-desc');

                if(me.isSpy) {
                    card.classList.add('spy');
                    icon.innerText = "üïµÔ∏è‚Äç‚ôÇÔ∏è";
                    title.innerText = "–¢–´ –®–ü–ò–û–ù";
                    desc.innerText = "–ù–µ –≤—ã–¥–∞–π —Å–µ–±—è!";
                } else {
                    card.classList.remove('spy');
                    icon.innerText = "üõ°Ô∏è";
                    title.innerText = me.location;
                    desc.innerText = "–ú–∏—Ä–Ω—ã–π –∂–∏—Ç–µ–ª—å";
                }
            },

            show: function(vis) {
                document.getElementById('role-card').style.display = vis ? 'block' : 'none';
                document.getElementById('reveal-btn').style.opacity = vis ? '0.2' : '1';
            }
        };

        function activateSecret() {
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
            alert("–Ø –ª—é–±–ª—é –°–æ–Ω—é ‚ù§Ô∏è");
        }

        // Auto init
        window.onload = () => Game.init();
    </script>
</body>
</html>
